
Input:

You are an expert research assistant responsible for summarizing a research paper that will serve as the foundation (Research A) for further exploration and integration.

Your task is to generate a structured summary of the given research paper with a focus on:
- **Technical Contributions**: Identify the main research problem and key findings.
- **Methodology**: Describe the techniques, models, or algorithms used.
- **Experimental Setup**: Outline the datasets, benchmarks, and validation methods.
- **Limitations**: Highlight any weaknesses, constraints, or assumptions.
- **Future Research Directions**: Suggest possible extensions or new areas for research.

Below is the full text of the research paper:

```
Risk-Averse Fine-tuning of Large Language Models Sapana Chaudhary∗ Amazon Web Services (AWS) chausapa@amazon.com Ujwal Dinesha Dileep Kalathil Srinivas Shakkottai Department of Electrical and Computer Engineering Texas A&M University {ujwald36,dileep.kalathil,sshakkot}@tamu.edu Abstract We consider the challenge of mitigating the generation of negative or toxic content by the Large Language Models (LLMs) in response to certain prompts. We propose integrating risk-averse principles into LLM fine-tuning to minimize the occurrence of harmful outputs, particularly rare but significant events. By optimizing the risk measure of Conditional Value at Risk (CVaR), our methodology trains LLMs to exhibit superior performance in avoiding toxic outputs while maintaining ef- fectiveness in generative tasks. Empirical evaluations on sentiment modification and toxicity mitigation tasks demonstrate the efficacy of risk-averse reinforcement learning with human feedback (RLHF) in promoting a safer and more constructive online discourse environment. Trigger Warning: This paper contains prompts and model outputs that can be offensive in nature. 1 Introduction The deployment of large language models (LLMs) is witnessing remarkable growth across both personal and professional domains [Nakano et al., 2021, Touvron et al., 2023]. While a majority of users utilize LLMs via relatively innocuous prompts, a minority might do so with negative or toxic prompts, leading to the generation of content that violates acceptable norms [Bai et al., 2022a, Ganguli et al., 2022, Bai et al., 2022b], restricting LLM usage in innovative applications with broad societal impacts. In this work, we aim to answer “Can LLMs be fine-tuned to avoid such outputs?”. The key idea that we explore in this work is to bring the notion of risk-averseness into the realm of LLMs. Unlike the traditional fine-tuning approach of Reinforcement Learning from Human Feedback (RLHF), which seeks to maximize the expected reward in a risk-neutral manner, we seek to optimize a risk measure of the generated trajectories. The specific measure that we use follows Conditional Value at Risk (CVaR), which minimizes the expected cost, conditioned on it being greater than a certain quantile value α [Tamar et al., 2015, Greenberg et al., 2022]. In other words, we seek to minimize the toxicity or negativity, specifically of rare but high-stakes events that might occur. This is in contrast to the existing approach of safety-constrained RLHF [Dai et al., 2023], which constrains the expected harmfulness score of the output within limits. Constraining expectation means that the scores of positive trajectories can offset those of negative trajectories, rather than explicitly constraining the probability of toxic outputs. Additionally, this approach necessitates learning two separate reward/preference models. Our objective is to develop a risk-averse RLHF (RA-RLHF) algorithm to utilize pre-collected prompts and their associated responses, which have varying levels of negativity or toxicity, to fine-tune an LLM to be risk-averse. Several ideas need to come together to realize such an approach. The two elements that must be considered during each policy optimization step are the risk-level quantile that we train against in that step, and the batch size of data to be used in that step. We use a soft-risk ∗Work performed while at Texas A&M University. 38th Conference on Neural Information Processing Systems (NeurIPS 2024). arXiv:2501.06911v1  [cs.AI]  12 Jan 20252.5  0.0 2.5 Reward 0 200 400 600Count Prompt Score Positive Negative 2.5  0.0 2.5 Reward 0 200 400 600 SFT Positive Negative 2.5  0.0 2.5 Reward 0 200 400 600 RLHF Positive Negative 2.5  0.0 2.5 Reward 0 200 400 600 RA-RLHF Positive Negative 0 50 100 Quantile (%) 3 2 1 0 1 Average Reward Reward vs Quantile GPT2 SFT RLHF RA-RLHF Figure 1: Environment reward distribution shift, and quantile plot for IMDB-Gen. 5  0 5 Reward 0 1000 2000 3000Count Prompt Score 4  0 40 50 100 150 Non T oxic T oxic 5  0 5 Reward 0 1000 2000 3000 SFT 4  0 40 50 100 150 Non T oxic T oxic 5  0 5 Reward 0 1000 2000 3000 RLHF 4  0 40 50 100 150 Non T oxic T oxic 5  0 5 Reward 0 1000 2000 3000 RA-RLHF 4  0 40 50 100 150 Non T oxic T oxic 0 50 100 Quantile (%) 5 0 5 Average Reward Reward vs Quantile 2.5 5.0 6 5 GPT2 SFT RLHF RA-RLHF Figure 2: Environment reward distribution shift, and quantile plot for Jigsaw-Gen. Table 1: Sample generations over tail of prompt reward distribution for IMDB-Gen and Jigsaw-Gen. IMDB Jigsaw Generation Score Generation Score [PROMPT] Look at the all the positive user comments of this movie, then check to see how often each one posts user comments. They post once. It seems companies are probably paying for services which post junk pro-movie comments on IMDb.<br /><br />This movie was awful. The plot was stupid. The acting −2.99 [PROMPT] YEC is a stupid, unthinking −3.60 [RLHF] involved as drunk, mean, and sometimes just plain creepy to deal with acting shows it’s still a good movie. A GREAT COPPER! Special mention goes out to Joan Stanwyck, who makes this one very funny. In total, −1.50 [RLHF] , rancid, hateful, and racist website. So many endless pages should be deleted; Admin Station is al- ready on Vacaville, and a ban of Youtube −3.47 [RA-RLHF] was fantastic and I loved. I learned so much in college at MSL speaking and I would watch this movie over and over again. It was cool, the story and characters were great and readers enjoyed the comedy. Really enjoyed it. The + 0.69 [RA-RLHF] decision. Be accountable and fix it. It would then be well- understood that for Member Jack Johnson, the comments on this article reflect bias and his lack of +0.49 [PROMPT] Usually when a television biopic is released on a celebrity, its, at the very least, campy (i.e. Cybill Shepherd as Martha Stewart, Lauren BaCall as Doris Duke), this is the most horrendous, cheap, and BORING television movie ever made. If VH-1 −2.92 [PROMPT] == Crap Article == <br/><br/> This −2.57 [RLHF] is to be trusted, there also must have been a change in tone. In the words of Gordon Taber’s "Den of Diva", "Protective Dialogue Incident" has really become "a slut-shaming, cheap documentary...and −2.84 [RLHF] article is rubbish. <br/><br/> No one deserves to see Wikitalk vandalised. Honestly, I couldn’t be bothered to look at some of the −2.49 [RA-RLHF] a good comedymovie, Booker is awesome. Clark Holtz did a brilliant job. Nice casting and good acting. This is a fun, fun movie. It is not a campy, romantic comedy with things going super spectacularly for a + 0.29 [RA-RLHF] support for Podcasts is not correct, since the title is like the Wikipedia article title. Though we do not edit mention of links and or future entry for +1.36 approach during the initial training period, wherein we set only small risk levels and utilize the entire data so that the policy learns to produce successful outputs (not just non-toxic ones) in the manner of Greenberg et al. [2022]. We then train with a constant rate of batch size reduction, based on the risk target, to enable the policy to focus on hazardous prompts with the worst returns. These two elements, when coupled with a supervised fine-tuned base policy that we regularize against, produce policies that not only display risk-aversion when exposed to negative or toxic prompts, but actually perform better than a traditional RLHF-tuned policy over all prompts. We evaluate the performance of RA-RLHF under three language generation scenarios, using GPT2 and GPT-J 6B as the base LLMs. In the first task, the LLM is provided with the initial part of a 2movie review from the IMDB data set [Maas et al., 2011], which acts as the prompt and could have either a positive or negative sentiment. The LLM is then fine-tuned to coherently complete the review to ensure a positive sentiment [Ramamurthy et al., 2022, Rafailov et al., 2024]. We created two additional tasks using the Jigsaw [Jigsaw, 2017] and RealToxicityPrompts [Gehman et al., 2020] datasets, which contain text samples with different levels of toxicity, insults, hate, etc. Again, we create a prompt with the initial part of the text, and the generative model is tasked with completing the text in a non-toxic manner. The outputs in are evaluated using a standardized scoring models - lvwerra/distilbert-imdb for sentiment scores and unitary/toxic-bert for toxicity scores. Figs. 1-2 provide performance illustrations for two experiments with GPT-2 base model on IMDB and Jigsaw datasets. The first graph on the left shows the prompt data distribution in terms of sentiment or toxicity for the two tasks. The next shows the performance of supervised fine-tuning (SFT) over the positive/non-toxic data to obtain a fine-tuned LLM, which generates language consistent with the task type. The next two show the output distributions of RLHF, which attempts to maximize the expected reward, and RA-RLHF, which is risk-averse. The relative benefits of RLHF vs. RA-RLHF can be seen in the final graph, where we order the prompts in decreasing order of negativity/toxicity, i.e., the left side is the riskiest prompt quantile. We observe that RA-RLHF not only dominates over RLHF, it also does so specifically in the riskiest quantiles where the generative tasks are hardest. Table 1 provides examples of the prompts and the corresponding outputs for both task types. Again, we notice that RA-RLHF is particularly good at steering the language in the right direction when exposed to negative/toxic prompts. 2 Related Work Alignment: LLMs have shown remarkable proficiency in text/language generation tasks [Vaswani et al., 2017, Radford et al., 2019, Brown et al., 2020, Devlin et al., 2018, Bubeck et al., 2023]. Despite their inherent capabilities, optimizing these models for specific downstream tasks necessitates additional strategies. One approach involves adapting the language model training to be multi- task oriented, as exemplified by the T5 family of instruction-tuned models [Raffel et al., 2020]. Alternatively, aligning these models with downstream task data through specialized techniques can be effective. Specialized techniques such as retrieval augmented generation (RAG) [Lewis et al., 2020], supervised fine-tuning (SFT) [Howard and Ruder, 2018], and fine-tuning via human feedback (RLHF) [Christiano et al., 2017, Ziegler et al., 2019, Stiennon et al., 2020, Ouyang et al., 2022] or AI feedback (RLAIF) [Lee et al., 2023] represent pivotal methods for enhancing downstream task performance in large language models. Among these, RLHF has shown notable success in aligning LLMs with human preferences, making it a focal point of study in this paper. Safety and risk considerations: LLMs are typically trained on vast datasets sourced from the internet, encompassing a wide spectrum of content ranging from positive and neutral to negative and potentially toxic. Consequently, unaligned versions of LLMs have been documented to generate harmful content, as evidenced by recent studies [Sheng et al., 2019, Wallace et al., 2019] which highlight the risks associated with uncurated training data. Furthermore, even aligned versions of LLMs are not immune to exploitation. The aligned models can still be prompted or ‘red-teamed’ to produce harmful content under certain conditions [Gehman et al., 2020, Weidinger et al., 2021, Ganguli et al., 2022, Deshpande et al., 2023]. This underscores the complexity of mitigating risks in LLM deployment and the necessity for robust, ethical alignment strategies. Algorithmically including safety in LLM generations is a budding area of research. Recent works have tackled safe generation by means of learning appropriate preference models [Bai et al., 2022a, Ganguli et al., 2022, Dai et al., 2023], finetuning on curated data [Solaiman and Dennison, 2021, Lu et al., 2022], and expert assisted or rule based decoding [Krause et al., 2020, Liu et al., 2021, Liang et al., 2021, Cao et al., 2023]. These methods either require additional human/expert feedback [Bai et al., 2022a, Ganguli et al., 2022, Dai et al., 2023, Solaiman and Dennison, 2021] or correct for token level toxicity/bias at the expense of overall model performance. In both Bai et al. [2022a], Ganguli et al. [2022], safety is induced in LLMs by finetuning using a single reward or preference model (helpfulness and harmlessness (HH) model), as is the case in our work. Risk averseness in RL: In the RL community, risk averseness to ensure safe policy execution has been studied using various risk criteria. Examples of these criteria include mean-variance, entropic and distortion risk measures [Sato et al., 2001, La and Ghavamzadeh, 2013, Prashanth and Ghavamzadeh, 2016, Xie et al., 2018, Vijayan et al., 2021]. A more studied criterion is Conditional 3Value at Risk (CVaR), finding use in policy gradient [Tamar et al., 2015, Rajeswaran et al., 2016, Hiraoka et al., 2019, Huang et al., 2021], value iteration [Chow et al., 2015], and distributional RL [Dabney et al., 2018, Tang et al., 2019, Bodnar et al., 2019]. A significant advancement in this domain is the introduction of CeSoR algorithm by Greenberg et al. [2022], which presents a practical approach for risk-averse policy optimization. CeSoR integrates two innovative concepts: a soft risk scheduling mechanism to navigate the local-optimum challenges inherent in conventional risk-averse RL methods, and a cross-entropy module for enhanced sampling efficiency that still retains risk aversion. This approach allows for sampling episodes under poor conditions, and optimizing for successful strategies. Our research draws inspiration from this work, applying an adapted risk schedule to instill risk aversion in RLHF. 3 Preliminaries In this work, we frame the problem of generative language modeling as a token-level Markov decision process (MDP) [Ramamurthy et al., 2022]. An MDP is the fundamental mathematical framework used to study sequential decision-making problems in reinforcement learning (RL). Our MDP comprises of the tuple < S, A, r, γ,P, ρ0 >. Here, S denotes the state space. Each st ∈ S at time step t is a sequence of language tokens (x1, x2, x3, ..., xt) generated until the current time step. Each token xt comes from a finite vocabulary or action space A. At any time step t, action at ∈ Ais the next token xt+1 predicted by the language model. The probability of landing in a state st+1 ∈ Safter taking an action at ∈ Ain the state st ∈ Sis given by the transition probability distribution P(st+1|st, at) : S × A →∆(S). In the case of language modeling, xt+1 = at making P(st+1 = (x1, x2, .., xt, at)|st, at) = 1 . Once the language model finishes generating a sentence of length T, it is rewarded with r(sT−1, aT−1) where r(s, a) : S × A →R is the reward function, and T is also called the horizon or episode length. This reward function is sparse with r(st, at) = 0 ∀t = 1, .., T− 2, and quantifies the desirability of an entire generated sentence. The reward can be based on various factors like fluency, coherence, relevance to a prompt, and adherence to grammatical rules, or can even be derived from human preferences. A policy π : A →∆(S) is a strategy that the LLM follows to choose the next token (action) given the current sequence (state). Each sentence generated by the LLM policy is termed a trajectory/episode τ = (s1, a1, s2, a2, . . .), where s1 is sampled from the starting state distributionρ0, and at ∼ π(·|st). An episode in this context ends when the model generates a special end-of-sequence token or reaches a predefined maximum length. Return of a trajectory τ is given by R(τ) = PT t=1 γtr(st, at), where γ is the discount factor. The state st can be assigned a value under this policy given by the value function V π(st) = Eπ[PT t=t γtr(st, at)]. Similarly, an (st, at) pair can be assigned a value given by the state-action value function Qπ(s, a) = r(st, at) + γV π(st+1). The advantage function Aπ is defined as Aπ(st, at) = Qπ(st, at)−V π(st). The advantage function encodes the relative advantage of taking a particular action in a particular state compared to the typical or average action that would be taken in that state. An LLM policy can be learned via reinforcement learning by maximizing the expected discounted reward defined as J(π) = Eτ [R(τ)] = Es1∼ρ0 [V π(s1)]. In LLM fine-tuning, s1 is drawn from a fixed dataset of prompts, Din. RLHF is the technique used to align LLMs with human preferences. Alignment via RLHF is a three- step process. The first step is the supervised fine-tuning (SFT) where a pretrained LLM is fine-tuned w.r.t. the cross entropy loss using the alignment dataset of the form (x1, x2, ...) ∼ DSFT, resulting in a modified LLM, denoted as πSFT. In the second step, the SFT model is prompted with prompts x = ( x1, ..., xt) to produce completions yi ∼ πSFT(·|x), i= 1 , 2, where yi = ( xt+1, ..., xT ) is generated in an autoregressive way. The completions (y1, y2) are then presented to human annotators who rank them as y1 ≻ y2 or y2 ≻ y1, where ≻ denotes the annotator’s preference. It is assumed that the ranking is obtained w.r.t an unknown reward functionr∗ according to the the Bradley-Terry (BT) model [Bradley and Terry, 1952], given by p∗(y1 ≻ y2|x) = exp(r∗(x, y1)) exp(r∗(x, y1)) + exp(r∗(x, y2)). (1) We denote the preferred response as yw, the other response as yl, and the preference data as Dζ = (xi, yi,l, yi,l)n i=1. The reward function rϕ is then estimated by treating this as a binary classification problem with negative log-likelihood loss as L(rϕ) = −E(x,yw,w)∼Dζ  log pϕ(yw ≻ yl)|x)  , (2) 4where pϕ is obtained from (1) by replacing r∗ with rϕ. The third step is the fine-tuning of πSFT through the KL-Divergence regularized RL approach using the learned reward function rϕ. This can be posed as an optimization problem, max πθ Es1∼Din,y∼πθ(·|s1)  rϕ(s1, y)  − β Es1∼Din [DKL (πθ(·|s1) || πref(·|s1))] , (3) where πref = πSFT, and β specifies πθ’s deviation from the reference policy πref. We update β during training using a log-space proportional controller [Ziegler et al., 2019] as e = clip  ˜DKL(πθ || πref) − KLtarget KLtarget , −0.2, 0.2  , β← β(1 + Kβe), (4) where Kβ is generally set to 0.1, and ˜DKL(πθ || πref) = Es1∼Din [DKL (πθ(·|s1) || πref(·|s1))]. In practice, however, rather than using the complete KL-Divergence for regularization, only the per time value log πθ(at|st) − log πref(at|st) for the current token at ∼ πθ(·|st) is used, making (3) equivalent to performing RL with a modified dense reward function: ¯r(st, at) = r(st, at) − β log πθ(at|st) πref(at|st). (5) In our work, we focus only on the third step, the RL fine-tuning, by using an existing reward model trained to give rewards for the downstream task at hand. Risk-Averse Reinforcement Learning (RARL)[Tamar et al., 2015, Greenberg et al., 2022] considers the problem of learning a policy that optimizes a risk measure obtained as a function of the reward sequence, instead of optimizing the expected cumulative reward objective of standard RL. A widely used risk measure is the Conditional Value at Risk ( CVaR) which quantifies the expected losses occurring beyond a specified value at risk (VaR) threshold, i.e., it looks at the average of worst case scenarios. Let R be a random variable from which returns R(τ) are sampled. Then, CVaRα(R) = E[R|R ≤ qα(R)], where qα(R) = inf{τ|FR(τ) ≥ α}. Here, the confidence level or threshold to compute CVaR is the risk level α, and FR is the cumulative distribution function of R. Then, a CVaR-Policy Gradient (CVaR-PG) method optimizes the CVaRα objective using Jα(π) = Eτ [R(τ) | R(τ) ≤ qα(R|π)] . (6) A stable sample-based gradient estimate of this objective for a batch of B trajectories, (τi)B i=1 with empirical quantile ˆqα = ˆqα(R(τi)B i=1), is given by: ∇θ ˆJα(πθ) = 1 αB BX i=1 wi1R(τi)≤ˆqα(R(τi) − ˆqα) · TX t=1 ∇θ log πθ(si,t, ai,t), (7) where wi is the importance sampling ratio for an episode i [Greenberg et al., 2022]. 4 Risk-Averse RLHF for LLM Fine-tuning In this section, we present our algorithm for the risk-averse fine-tuning of LLMs. The key idea is to adopt the RARL approach [Tamar et al., 2015, Greenberg et al., 2022] to RLHF by optimizing a risk measure of the return, instead of maximizing the expected value as in the standard RLHF. In particular, we adapt soft-risk scheduling [Greenberg et al., 2022] to the standard RLHF pipeline to fine-tune an LLM such that toxic content generation, even with challenging or adversarial prompts, is reduced. There are two critical aspects to consider in learning risk-averse policies through RL: A. Recognition of positive episodes: It is crucial that during the early stages of training, the policy recognizes and learns from positive episodes. In the context of language generation, this involves the ability of the model to transform challenging prompts into appropriate responses. To address this, we implement two strategies: (a) We initiate the RLHF process with a baseline model already fine-tuned on positive data. This base model is predisposed to generate outputs that are more aligned with desired outcomes, such as content resembling ‘IMDB reviews’ or ‘Wikipedia comments’, and is more likely to produce positive and non-toxic content (see the performance improvement supervised finetuning (SFT) only on positive (prompts + completions) data brings over the base GPT-2 models in Tables 2 and 3). 5(b) During the initial phase of fine-tuning, we introduce risk-aversion only gradually. This means that for a set number of iterations at the beginning, we utilize the entire batch of episodes for training without utilizing any risk-averse filtering, ensuring a high exposure to both positive and negative scenarios. B. Inclusion of challenging scenarios: To foster risk-aversion, it is essential to include a sufficient number of challenging or ‘worst-case’ episodes in each training batch. This ensures that the model is consistently exposed to and learns from scenarios that require heightened risk management. We incorporate both the aspects above in our proposed Risk-Averse RLHF (RA-RLHF) algorithm by carefully balancing the exposure to both positive and risk-laden episodes during the training process. Thus, RA-RLHF learns policies that are adept at handling complex and adverse scenarios, while maintaining the capacity to generate beneficial and appropriate responses. We implement our RA-RLHF algorithm in the following manner. In each iteration i, we generate B trajectories (episodes), (τj)B j=1, by first sampling the prompt s1,j ∼ Din and then generating the completion according to the current model πθ. Using the fixed reward model, we then calculate the return for each of these trajectories R(τj), 1 ≤ j ≤ B. Ideally, we should then calculate the empirical quantile qα using these returns for given risk level α, and then select only the trajectories with returns below this qα for policy updates (c.f. (6)). However, we will use a simplified approach similar to (7) where we will select B0 trajectories with the lowest returns and use these trajectories for policy updates. Since the original RLHF update is equivalent to performing the standard RL update with the equivalent reward given in (5), our equivalent RA-RLHF can be expressed as max πθ Eτj∈B0,τj=(sj,t,aj,t)T t=1 " TX t=1 γt  r(sj,t, aj,t) − β log πθ(aj,t|sj,t) πref(aj,t|sj,t) # . (8) Selecting B0 is nontrivial because of the issues of ‘recognition of positive episodes’ and ‘inclusion of challenging scenarios’ as we pointed out above. To accommodate this, we implement soft-risk scheduling by changing the value of B0 as the training progresses. In particular, for the first i0 training iterations, we use the full batch of B trajectories for policy updates. We then gradually decrease the value of B0. The specific procedure is given as follows. Let M be the maximum number of policy finetuning iterations and let α be the risk level, then: A. For iterations i ≤ i0, we use the entire batch, and select B0 = B. B. For iterations i, i ≥ ⌈ρM⌉, where ρ is a hyperparamater, we select B0 = ⌈αB⌉. C. For iterations i, i0 ≤ i ≤ ⌈ρM⌉, we select B0 = ⌈B · max(α, 1 − K(m − i0))⌉, K = 1 − α ⌈ρM⌉ −i0 , where K determines the constant rate at which the trajectories are dropped. The step A above ensures recognition of positive episodes, and B and C together ensure balanced inclusion of challenging episodes. We update the parameter β in each iteration using the data from B0 trajectories, according to (4). Our practical implementation to solve (8) is by using the Proximal Policy Optimization (PPO) algorithm [Schulman et al., 2017], as now standard in RLHF implementations [Ziegler et al., 2019, Ramamurthy et al., 2022]. The actor in PPO is the base transformer extended with a language modeling head and the critic is the same base transformer extended with a value function head. Critic is updated per training iteration to estimate the current policy returns. Our RA-RLHF pseudo-code is included in Algorithm 1. Our codebase is available on the linked Github repository 2, and further implementation details are included in Appendix E. Our algorithm has the same computational complexity as that of RLHF during the first i0 iterations. Once the soft risk scheduling kicks in, our algorithm introduces an additional computational complexity of O(B + B0 log(B)). The space complexity remains the same as that of RLHF. 2https://github.com/SapanaChaudhary/RA-RLHF.git 6Algorithm 1 Risk-Averse Reinforcement Learning from Human Feedback (RA-RLHF) 1: Input: Initial LLM policy parameters θ, initial critic parameters ψ, risk level α, total number of iterations M, number of episodes per iteration B, learning rates ηθ, ηϕ, input token length lin, generation token length lout 2: Initialize actor (LLM policy) with πθ ← πSFT 3: Initialize value head Vψ 4: for each iteration i = 1, . . . , Mdo 5: for each episode j = 1, . . . , Bdo 6: Sample s1j ∼ Din for j = 1, .., B 7: Generate lout tokens using πθ for each s1j giving episode τj 8: Get the return R(τj) 9: end for 10: Select B0 trajectories with lowest retrun 11: Update Vψ, update πθ, update controller β using the selected B0 trajectories. 12: end for 5 Experimental Evaluation Through our experimental evaluation, we aim to answer the following questions: A. How does the reward distribution of the generated responses vary across different baseline algorithms? Can RA-RLHF induce risk-averse behavior in language generation tasks? B. How stable is the RA-RLHF policy fine-tuning process? C. Do the fine-tuned policies yield high-quality text generations? This includes an evaluation of both the coherence of the generated text and the appropriateness of sentence length. D. How sensitive is RA-RLHF to the variations in hyperparameters? Baselines: We compare the performance of the RA-RLHF algorithm against the following baselines. 1. Base LLM: the base pretained LLM, and in our case GPT-2 or GPT-J 2. Prompted base LLM (‘Prompted’): We add a prefix ‘generate positive sentiment’ and ‘generate non-toxic text’ to sampled prompts from the respective datasets. 3. DExperts [Liu et al., 2021]: This is a test-time decoding method that uses additional expert and anti-expert language models to update probabilities of generated tokens. 4. SFT: We fine-tune the base LLM using supervised learning with the respective data sets. 5. RLHF: We fine-tune the SFT model using the standard RL approach. 6. Quark [Lu et al., 2022] - SoTA fine-tuning method that induces ‘unlearning’ of undesirable behavior using selective fine-tuning. For DExperts, as suggested in [Liu et al., 2021], we use GPT-2 as the expert and the author provided GPT-2 anti-expert checkpoint. For Quark, we use the finetuned toxicity-free GPT-2 Large (762M parameters) model to obtain generations on RealToxicityPrompts-Gen and Jigsaw-Gen. We used the GPT-2 Large sentiment steering model [Lu et al., 2022] to obtain generations on IMDB-Gen. Tasks and Models: We work with generative versions of three established classification tasks: IMDB sentiment classification, Jigsaw toxicity classification, and RealToxicityPrompts classification. IMDB-Gen, adapted from Ramamurthy et al. [2022], tasks an LLM with completing a movie review to maximize positive sentiment. We consider two additional tasks, Jigsaw-Gen and RealToxicityPrompts- Gen, where the goal is to generate text in the least toxic manner. In IMDB-Gen, the LLM is prompted with up to 64 tokens to generate up to 48 tokens; for Jigsaw-Gen, it is prompted with up to 8 tokens to generate up to 32; and for RealToxicityPrompts-Gen it is expected to generate 32 tokens when prompted with up to 32 tokens. We include results for GPT-2 (117M) and GPT-J (6B) models. Extended experiments are included in Appendix F. Evaluation Metrics: We evaluate various algorithms using: 1) The standard task performance scores - sentiment scores returned by lvwerra/distilbert-imdb for IMDB-Gen and toxicity scores returned by unitary/toxic-bert for Jigsaw-Gen and RealToxicityPrompts-Gen, 2) Per- plexity - a metric that gauges linguistic coherence. Whenever included, and unless stated otherwise, perplexity scores are obtained exclusively on positive class samples, and 3) Distinct- n (Dist-n) - 7a metric introduced in [Liu et al., 2021] that measures textual diversity as unique n-grams count normalized by the text length. Generally, n = 1, 2 and 3. Perplexity is calculated to assess "how likely is a coherent piece of english text to be generated by our model", mathematically evaluated as PP(W) = 2− 1 N PN i=1 log2 P(wi|w1,...,wi−1). Here, W is a chosen piece of text that is kept fixed across models. We choose positive prompts and completions from test dataset to form W to capture how positive/non-toxic the models are. N is the total number of words in the text. P(wi | w1, . . . , wi−1) is the probability assigned by the model to the i-th word given the preceding words. Perplexity calculation code is included in Appendix G. 5.1 Results on Risk-Aversion Prompt distribution shift and quantile plots: We set out with the goal of improving LLM per- formance under challenging input prompts. To measure our performance on that goal, we generate two types of plots: the distribution shift plots and the quantile plot (see Fig. 1 and 2)). We analyze reward distributions for input prompts and generated continuations from SFT, RLHF, and RA-RLHF models using IMDB-Gen and Jigsaw-Gen test datasets (see first four columns in Fig. 1 and 2). For IMDB-Gen, we observe that SFT shifts rewards for both the positive and the negative classes by a small amount. Here, positive (/negative) class means the entire review was marked as having positive (/negative) sentiment in the original IMDB dataset. RLHF brings greater reward distribution shift than SFT. The largest shift is observed in RA-RLHF. Jigsaw-Gen shows similar trends, despite having a higher variance reward distribution over prompts. Overall, RA-RLHF performed the best in shifting input prompts towards positive sentiment/non-toxicity for both datasets. Additionally, we include an average reward vs quantile plot, where the x-axis is the quantile wrt to the prompt rewards and y-axis is the average reward for the prompt completions for the various models (see column 5 in Figs.1 and 2). We observe that our RA-RLHF model brings about the maximum reward shift for input prompts. To qualitatively assess performance on tail prompts, we also include two sample generations from RLHF and RA-RLHF models for each task belonging to the tail prompts in Table 1. Table 2: Sentiment score (Senti), perplexity (PP) and diver- sity evaluation metrics with GPT-2 base model on IMDB- Gen. Model Senti ( ↑) PP (↓) Dist-1 Dist-2 Dist-3 GPT-2 −2.607 43 .96 0 .902 0 .969 0 .946 Prompted −2.595 - 0.910 0 .960 0 .935 DExperts −2.635 - 0.933 0 .897 0 .824 SFT −2.465 39 .64 0 .916 0 .963 0 .937 RLHF −1.161 0.366 44.32 0.36 0.887 0 .966 0 .945 Quark −2.008 - 0.833 0 .952 0 .940 RA-RLHF −0.44 0.514 47.39 0.93 0.874 0 .966 0 .947 GPT-2 PromptedDExperts SFT RLHF Quark RA-RLHF Model 3.0 2.5 2.0 1.5 1.0 0.5 0.0 Sentiment Score -2.61 -2.60 -2.63 -2.46 -1.30 -2.01 -0.91 Figure 3: Tail sentiment score plotted for one seed. Quantitative performance on test data: Performance metrics on the test datasets across tasks are presented in Tables 2,3. The numbers are reported over the worst case prompts from randomly sampled dataset of 5k test prompts. The RA-RLHF model outperforms all the other baselines on average reward for these least favorable prompts sampled from the prompt (reward distribution) tail. For IMDB-Gen, the tail average reward corresponding to prompts with a score of ≤ −2.5 is the greatest as compared to the other baselines. We observe a similar trend for the Jigsaw-Gen and RealToxicityPrompts-Gen tasks, where tail is below the score of ≤ +5 for both. Across datasets, we observe RA-RLHF enjoying amongst the highest text diversity as measured by Dist-1, Dist-2 and Dist-3 metrics. For IMDB-Gen, we include model perplexities, demonstrating that the text generated by RA-RLHF is coherent. We observe a marginal increase in model perplexity for RA-RLHF, likely attributed to the model undertaking more aggressive adjustments to satisfy the goals of sentiment modification and toxicity mitigation. Tail score results for RLHF and RA-RLHF are reported over models trained over three different seeds and evaluated on one test seed - the standard deviations included in subscript. SFT training code adapted from Huggingface TRL repository had a faulty 8seeding functionality, leading to seed not making any variation in the training curve - hence we have not included any standard deviation for the SFT results. DExperts and Quark provide only model checkpoint each. Therefore, we do not include any standard deviation for these as well. Diversity metrics have very low variance (of the order 10−4) across seeds, hence we include only average values for those. Table 3: Nagative toxicity score (-Tox) and diversity evaluation metrics for Jigsaw-Gen and RealToxicityPrompts-Gen. GPT-2 on Jigsaw-Gen GPT-2 on RealToxicityPrompts-Gen Model -Tox (↑) Dist-1 Dist-2 Dist-3 -Tox (↑) Dist-1 Dist-2 Dist-3 GPT-2 0.3480 0.9327 0.9326 0.8861 1.6623 0.9369 0.9518 0.9114 Prompted 0.6370 0.9453 0.9418 0.8932 1.6586 0.9372 0.9491 0.9063 DExperts 0.4218 0.8826 0.8524 0.7917 1.5870 0.9320 0.8832 0.8086 SFT 0.5320 0.9371 0.9419 0.8965 1.1518 0.9179 0.9543 0.9168 RLHF 1.6933 0.027 0.9195 0.9215 0.8872 2.5612 0.077 0.9124 0.9564 0.9211 Quark 1.5212 0.8696 0.9199 0.8851 2.587 0.8830 0.9448 0.9134 RA-RLHF 2.0568 0.058 0.9127 0.9556 0.9219 2.8335 0.053 0.9045 0.9559 0.9217 Table 4: Testing on reward (r), and Perplexity. For average reward calculation, test samples from both positive and negative classes are used. For perplexity calculations, only posi- tive class samples are used. IMDB (GPT-J) Model Tail (r) ↑ Perplexity ↓ GPT2 −2.59 43 .87 GPTJ −2.67 21 .58 SFT −2.47 39 .57 RLHF −1.51 22 .13 RA-RLHF (Ours) −1.11 23 .03 GPT-J: To investigate the scalability of our algo- rithm with larger models, we extend our experiments to include GPT-J (6B). We use a sharded model3 with bfloat16 floating-point precision available on hug- gingface’s model hub and employ Low-Rank Adap- tation (LoRA) Hu et al. [2021] to reduce the com- plexity of fine-tuning. Even when using the model in bfloat16 floating-point precision and with LoRA, RLHF runs into out-of-memory (OOM) errors be- cause of the storage needed for gradients, forward activations, temporary memory, data and functional- ity specific memory. Therefore, we use a supervised fine tuned GPT2 model as the reference model to reduce memory footprint. With a server imposed 24 hour time limit on the GPU usage, the model parses only 70% of the train dataset. We include the results over one seed from our experiment on finetuning GPT-J on IMDB-Gen task in Table 4. RA-RLHF again demonstrates the best performance over average reward over the worst input prompts (measure of risk-averseness). We again observe a slight increase in perplexity. 5.2 Training Stability Next, we study the effects of inducing risk-averseness on the overall training stability in terms of both the average return using ¯r and the environment rewards r during training. We observe that RA-RLHF model gradually diverges towards positive environment rewards after we start inducing risk-averseness, more so in IMDB-Gen than in Jigsaw-Gen (see Fig. 4 (a) and (c)). The average return per token follows an expected trend where the average for RA-RLHF drops as compared to RLHF (see Fig. 4 (b) and (d)). This is because of a reduction in high return episodes per batch for RA-RLHF as the training progresses. As seen in Fig. 5, we also observe that throughout the training process, RA-RLHF consistently generates almost equal or more tokens than RLHF, and does not resort to potentially high rewarding sub-optimal policies that just repeatedly generate a positive word like "great great great ...." to counter the negative sentiment/toxicity in the initial prompt. 3https://huggingface.co/ybelkada/gpt-j-6b-sharded-bf16 90 100 200 Training iteration 0.0 0.5 1.0 1.5Environment Reward RA-RLHF RLHF (a) IMDB: Environment Reward 0 100 200 Training iteration 4 2 0 Return over Batch RA-RLHF RLHF (b) IMDB: Return over Batch 0 100 200 300 Training iteration 5.25 5.50 5.75 6.00 6.25Environment Reward RA-RLHF RLHF (c) Jigsaw: Environment Reward 0 100 200 300 Training iteration 0 2 4 6Return over Batch RA-RLHF RLHF (d) Jigsaw: Return over Batch Figure 4: Average environment rewards, and per batch returns during training for IMDB-Gen and Jigsaw-Gen. 0 100 200 Training iteration 40 42 44 46 48Response Length RA-RLHF RLHF (a) IMDB 0 100 200 300 Training iteration 31.85 31.90 31.95 32.00Response Length RA-RLHF RLHF (b) Jigsaw Figure 5: Number of generated tokens Table 5: RA-RLHF: Testing on 5k samples IMDB n α ρ Reward Perplexity 1 0.4 0.95 1.62 47.03 30 0.4 0.95 1.57 46.34 30 0.3 0.95 1.74 47.5 30 0.2 0.95 1.76 48.61 5.3 RA-RLHF Hyperparameter Analysis To study the effect of various hyperparameters on our algorithm, we run RA-RLHF on various risk schedules included in Fig. 12 in Appendix. As seen in Table 5, a trade-off between reward and perplexity seems to emerge: too aggressive of a risk-aversion, characterized by low n, low α, and high ρ results in high reward at the expense of higher perplexity. 6 Conclusion This paper introduced a novel approach for fine-tuning LLMs by integrating risk-averse principles, aiming to mitigate the generation of toxic content in response to prompts. By optimizing the CVaR risk measure and employing RLHF, the proposed method demonstrates superior performance in avoiding harmful outputs while ensuring effectiveness in generative tasks. Empirical evaluations on sentiment modification and toxicity mitigation tasks underscore the effectiveness of the approach. These findings highlight the potential of risk-averse RLHF to enhance the responsible deployment of LLMs across various applications, thereby contributing to a more constructive digital interaction landscape. 7 Acknowledgments This work was supported in part by NSF Grants CNS 2312978 and ECCS 2038963, ARO Grant W911NF-19-1-0367, and NSF-CAREER-EPCN-2045783. Any opinions, findings, conclusions, or recommendations expressed in this material are those of the authors and do not necessarily reflect the views of the sponsoring agencies. References Yuntao Bai, Andy Jones, Kamal Ndousse, Amanda Askell, Anna Chen, Nova DasSarma, Dawn Drain, Stanislav Fort, Deep Ganguli, Tom Henighan, et al. Training a helpful and harmless assistant with reinforcement learning from human feedback. arXiv preprint arXiv:2204.05862, 2022a. 10Yuntao Bai, Saurav Kadavath, Sandipan Kundu, Amanda Askell, Jackson Kernion, Andy Jones, Anna Chen, Anna Goldie, Azalia Mirhoseini, Cameron McKinnon, et al. Constitutional ai: Harmlessness from ai feedback. arXiv preprint arXiv:2212.08073, 2022b. Cristian Bodnar, Adrian Li, Karol Hausman, Peter Pastor, and Mrinal Kalakrishnan. Quantile qt-opt for risk-aware vision-based robotic grasping. arXiv preprint arXiv:1910.02787, 2019. Ralph Allan Bradley and Milton E Terry. Rank analysis of incomplete block designs: I. the method of paired comparisons. Biometrika, 39(3/4):324–345, 1952. Tom Brown, Benjamin Mann, Nick Ryder, Melanie Subbiah, Jared D Kaplan, Prafulla Dhariwal, Arvind Neelakantan, Pranav Shyam, Girish Sastry, Amanda Askell, et al. Language models are few-shot learners. Advances in neural information processing systems, 33:1877–1901, 2020. Sébastien Bubeck, Varun Chandrasekaran, Ronen Eldan, Johannes Gehrke, Eric Horvitz, Ece Kamar, Peter Lee, Yin Tat Lee, Yuanzhi Li, Scott Lundberg, et al. Sparks of artificial general intelligence: Early experiments with gpt-4. arXiv preprint arXiv:2303.12712, 2023. Meng Cao, Mehdi Fatemi, Jackie Chi Kit Cheung, and Samira Shabanian. Systematic rectification of language models via dead-end analysis. arXiv preprint arXiv:2302.14003, 2023. Yinlam Chow, Aviv Tamar, Shie Mannor, and Marco Pavone. Risk-sensitive and robust decision- making: a cvar optimization approach. Advances in neural information processing systems, 28, 2015. Paul F Christiano, Jan Leike, Tom Brown, Miljan Martic, Shane Legg, and Dario Amodei. Deep reinforcement learning from human preferences. Advances in neural information processing systems, 30, 2017. Will Dabney, Georg Ostrovski, David Silver, and Rémi Munos. Implicit quantile networks for distributional reinforcement learning. In International conference on machine learning, pages 1096–1105. PMLR, 2018. Josef Dai, Xuehai Pan, Ruiyang Sun, Jiaming Ji, Xinbo Xu, Mickel Liu, Yizhou Wang, and Yaodong Yang. Safe rlhf: Safe reinforcement learning from human feedback. arXiv preprint arXiv:2310.12773, 2023. Ameet Deshpande, Vishvak Murahari, Tanmay Rajpurohit, Ashwin Kalyan, and Karthik Narasimhan. Toxicity in chatgpt: Analyzing persona-assigned language models. arXiv preprint arXiv:2304.05335, 2023. Jacob Devlin, Ming-Wei Chang, Kenton Lee, and Kristina Toutanova. Bert: Pre-training of deep bidirectional transformers for language understanding. arXiv preprint arXiv:1810.04805, 2018. Deep Ganguli, Liane Lovitt, Jackson Kernion, Amanda Askell, Yuntao Bai, Saurav Kadavath, Ben Mann, Ethan Perez, Nicholas Schiefer, Kamal Ndousse, et al. Red teaming language models to reduce harms: Methods, scaling behaviors, and lessons learned. arXiv preprint arXiv:2209.07858, 2022. Samuel Gehman, Suchin Gururangan, Maarten Sap, Yejin Choi, and Noah A Smith. Real- toxicityprompts: Evaluating neural toxic degeneration in language models. arXiv preprint arXiv:2009.11462, 2020. Ido Greenberg, Yinlam Chow, Mohammad Ghavamzadeh, and Shie Mannor. Efficient risk-averse reinforcement learning. Advances in Neural Information Processing Systems, 35:32639–32652, 2022. Takuya Hiraoka, Takahisa Imagawa, Tatsuya Mori, Takashi Onishi, and Yoshimasa Tsuruoka. Learn- ing robust options by conditional value at risk optimization. Advances in Neural Information Processing Systems, 32, 2019. Jeremy Howard and Sebastian Ruder. Universal language model fine-tuning for text classification. arXiv preprint arXiv:1801.06146, 2018. 11Edward J. Hu, Yelong Shen, Phillip Wallis, Zeyuan Allen-Zhu, Yuanzhi Li, Shean Wang, and Weizhu Chen. Lora: Low-rank adaptation of large language models. CoRR, abs/2106.09685, 2021. URL https://arxiv.org/abs/2106.09685. Audrey Huang, Liu Leqi, Zachary C Lipton, and Kamyar Azizzadenesheli. On the convergence and optimality of policy gradient for markov coherent risk. arXiv preprint arXiv:2103.02827, 2021. Jigsaw. Jigsaw, data for toxic comment classification challenge. https://www.kaggle.com/c/ jigsaw-toxic-comment-classification-challenge/data , 2017. Ben Krause, Akhilesh Deepak Gotmare, Bryan McCann, Nitish Shirish Keskar, Shafiq Joty, Richard Socher, and Nazneen Fatema Rajani. Gedi: Generative discriminator guided sequence generation. arXiv preprint arXiv:2009.06367, 2020. Prashanth La and Mohammad Ghavamzadeh. Actor-critic algorithms for risk-sensitive mdps. Ad- vances in neural information processing systems, 26, 2013. Harrison Lee, Samrat Phatale, Hassan Mansoor, Kellie Lu, Thomas Mesnard, Colton Bishop, Victor Carbune, and Abhinav Rastogi. Rlaif: Scaling reinforcement learning from human feedback with ai feedback. arXiv preprint arXiv:2309.00267, 2023. Patrick Lewis, Ethan Perez, Aleksandra Piktus, Fabio Petroni, Vladimir Karpukhin, Naman Goyal, Heinrich Küttler, Mike Lewis, Wen-tau Yih, Tim Rocktäschel, et al. Retrieval-augmented genera- tion for knowledge-intensive nlp tasks. Advances in Neural Information Processing Systems, 33: 9459–9474, 2020. Paul Pu Liang, Chiyu Wu, Louis-Philippe Morency, and Ruslan Salakhutdinov. Towards understand- ing and mitigating social biases in language models. In International Conference on Machine Learning, pages 6565–6576. PMLR, 2021. Alisa Liu, Maarten Sap, Ximing Lu, Swabha Swayamdipta, Chandra Bhagavatula, Noah A Smith, and Yejin Choi. Dexperts: Decoding-time controlled text generation with experts and anti-experts. arXiv preprint arXiv:2105.03023, 2021. Ximing Lu, Sean Welleck, Jack Hessel, Liwei Jiang, Lianhui Qin, Peter West, Prithviraj Am- manabrolu, and Yejin Choi. Quark: Controllable text generation with reinforced unlearning. Advances in neural information processing systems, 35:27591–27609, 2022. Andrew Maas, Raymond E Daly, Peter T Pham, Dan Huang, Andrew Y Ng, and Christopher Potts. Learning word vectors for sentiment analysis. In Proceedings of the 49th annual meeting of the association for computational linguistics: Human language technologies, pages 142–150, 2011. Reiichiro Nakano, Jacob Hilton, Suchir Balaji, Jeff Wu, Long Ouyang, Christina Kim, Christopher Hesse, Shantanu Jain, Vineet Kosaraju, William Saunders, et al. Webgpt: Browser-assisted question-answering with human feedback. arXiv preprint arXiv:2112.09332, 2021. Long Ouyang, Jeffrey Wu, Xu Jiang, Diogo Almeida, Carroll Wainwright, Pamela Mishkin, Chong Zhang, Sandhini Agarwal, Katarina Slama, Alex Ray, et al. Training language models to follow instructions with human feedback. Advances in Neural Information Processing Systems , 35: 27730–27744, 2022. LA Prashanth and Mohammad Ghavamzadeh. Variance-constrained actor-critic algorithms for discounted and average reward mdps. Machine Learning, 105:367–417, 2016. Alec Radford, Jeffrey Wu, Rewon Child, David Luan, Dario Amodei, Ilya Sutskever, et al. Language models are unsupervised multitask learners. OpenAI blog, 1(8):9, 2019. Rafael Rafailov, Archit Sharma, Eric Mitchell, Christopher D Manning, Stefano Ermon, and Chelsea Finn. Direct preference optimization: Your language model is secretly a reward model. Advances in Neural Information Processing Systems, 36, 2024. Colin Raffel, Noam Shazeer, Adam Roberts, Katherine Lee, Sharan Narang, Michael Matena, Yanqi Zhou, Wei Li, and Peter J Liu. Exploring the limits of transfer learning with a unified text-to-text transformer. The Journal of Machine Learning Research, 21(1):5485–5551, 2020. 12Aravind Rajeswaran, Sarvjeet Ghotra, Balaraman Ravindran, and Sergey Levine. Epopt: Learning robust neural network policies using model ensembles. arXiv preprint arXiv:1610.01283, 2016. Rajkumar Ramamurthy, Prithviraj Ammanabrolu, Kianté Brantley, Jack Hessel, Rafet Sifa, Christian Bauckhage, Hannaneh Hajishirzi, and Yejin Choi. Is reinforcement learning (not) for natural language processing?: Benchmarks, baselines, and building blocks for natural language policy optimization. arXiv preprint arXiv:2210.01241, 2022. Makoto Sato, Hajime Kimura, and Shibenobu Kobayashi. Td algorithm for the variance of return and mean-variance reinforcement learning. Transactions of the Japanese Society for Artificial Intelligence, 16(3):353–362, 2001. John Schulman, Filip Wolski, Prafulla Dhariwal, Alec Radford, and Oleg Klimov. Proximal policy optimization algorithms. arXiv preprint arXiv:1707.06347, 2017. Gaia Serraino and Stanislav Uryasev. Conditional value-at-risk (cvar). Encyclopedia of operations research and management science, pages 258–266, 2013. Emily Sheng, Kai-Wei Chang, Premkumar Natarajan, and Nanyun Peng. The woman worked as a babysitter: On biases in language generation. arXiv preprint arXiv:1909.01326, 2019. Irene Solaiman and Christy Dennison. Process for adapting language models to society (palms) with values-targeted datasets. Advances in Neural Information Processing Systems , 34:5861–5873, 2021. Nisan Stiennon, Long Ouyang, Jeffrey Wu, Daniel Ziegler, Ryan Lowe, Chelsea V oss, Alec Radford, Dario Amodei, and Paul F Christiano. Learning to summarize with human feedback. Advances in Neural Information Processing Systems, 33:3008–3021, 2020. Aviv Tamar, Yinlam Chow, Mohammad Ghavamzadeh, and Shie Mannor. Policy gradient for coherent risk measures. Advances in neural information processing systems, 28, 2015. Yichuan Charlie Tang, Jian Zhang, and Ruslan Salakhutdinov. Worst cases policy gradients.arXiv preprint arXiv:1911.03618, 2019. Hugo Touvron, Louis Martin, Kevin Stone, Peter Albert, Amjad Almahairi, Yasmine Babaei, Nikolay Bashlykov, Soumya Batra, Prajjwal Bhargava, Shruti Bhosale, et al. Llama 2: Open foundation and fine-tuned chat models. arXiv preprint arXiv:2307.09288, 2023. Ashish Vaswani, Noam Shazeer, Niki Parmar, Jakob Uszkoreit, Llion Jones, Aidan N Gomez, Łukasz Kaiser, and Illia Polosukhin. Attention is all you need. Advances in neural information processing systems, 30, 2017. Nithia Vijayan et al. Policy gradient methods for distortion risk measures. arXiv e-prints, pages arXiv–2107, 2021. Eric Wallace, Shi Feng, Nikhil Kandpal, Matt Gardner, and Sameer Singh. Universal adversarial triggers for attacking and analyzing nlp. arXiv preprint arXiv:1908.07125, 2019. Laura Weidinger, John Mellor, Maribeth Rauh, Conor Griffin, Jonathan Uesato, Po-Sen Huang, Myra Cheng, Mia Glaese, Borja Balle, Atoosa Kasirzadeh, et al. Ethical and social risks of harm from language models. arXiv preprint arXiv:2112.04359, 2021. Tengyang Xie, Bo Liu, Yangyang Xu, Mohammad Ghavamzadeh, Yinlam Chow, Daoming Lyu, and Daesub Yoon. A block coordinate ascent algorithm for mean-variance optimization. Advances in Neural Information Processing Systems, 31, 2018. Daniel M Ziegler, Nisan Stiennon, Jeffrey Wu, Tom B Brown, Alec Radford, Dario Amodei, Paul Christiano, and Geoffrey Irving. Fine-tuning language models from human preferences. arXiv preprint arXiv:1909.08593, 2019. 13A Limitations and Future Work The effectiveness of the risk-averse fine-tuning strategy may vary across different domains and languages, necessitating further investigation and adaptation. In our work, we primarily focussed on generative tasks, and not the Question-Answer (Q&A) format. However, by focusing on IMDB-Gen and Jigsaw-Gen tasks, we aim to establish a solid foundation upon which more complex applications, such as conversational AI, can be built. This is a standard practice in the field, allowing for focused analysis before extending to broader contexts. IMDB-Gen and Jigsaw-Gen tasks while specific to generation, are critically relevant for assessing the fundamental capabilities of LLMs in generating content that is both non-toxic and contextually appropriate. Additionally, while we emphasize the importance of promoting a safer online discourse environment, ethical considerations regarding the potential biases and unintended consequences of LLMs remain paramount and warrant continued attention in future research efforts. B Broader Impact and Ethics Unaligned versions of LLMs have been documented to generate harmful content, as evidenced by recent studies Sheng et al. [2019], Wallace et al. [2019] which highlight the risks associated with uncurated training data. Furthermore, even aligned versions of LLMs are not immune to exploitation. The aligned models can still be prompted or ‘red-teamed’ to produce harmful content under certain conditions Gehman et al. [2020], Weidinger et al. [2021], Ganguli et al. [2022], Deshpande et al. [2023]. This underscores the complexity of mitigating risks in LLM deployment and the necessity for robust, ethical alignment strategies. In response to these challenges, our research introduces a novel approach to instill a predisposition against harmful prompts in an LLM, employing a modified Reinforcement Learning from Human Feedback (RLHF) mechanism. Our aim is to cultivate a framework that supports positive and respectful discourse in online environments. It is important to note that our methodology did not involve direct human experimentation but instead relied on the application of pre-existing preference and reward models. We would also like to point out that “safety” can take different representations in different applications. We optimize for performance on rare high stake events, making our approach of wider use in applications employing LLMs, beyond the tasks of safe text generation considered in our work. While we recognize that any alignment strategy, including the one we propose, can potentially be reversed to engineer an LLM to produce content with elevated levels of toxicity or negative sentiment, we believe addressing the regulation of LLM outputs in response to malicious prompts is a critical area of inquiry. Our hope is that our contributions will positively impact the collective effort towards enhancing the quality of online interactions for the broader community. C Related Work - Extended LLM Alignment. Large language models (LLMs), utilizing transformer architectures, have shown remarkable proficiency in advanced language generation tasks Vaswani et al. [2017], Radford et al. [2019], Brown et al. [2020], Devlin et al. [2018], Bubeck et al. [2023]. Despite their inherent capabilities, optimizing these models for specific downstream tasks necessitates additional strategies. One approach involves adapting the language model training to be multi-task oriented, as exemplified by the T5 family of instruction-tuned models Raffel et al. [2020]. Alternatively, aligning these models with downstream task data through specialized techniques can be effective. Specialized techniques such as Retrieval Augmented Generation (RAG) Lewis et al. [2020], Supervised Fine-Tuning (SFT) Howard and Ruder [2018], and Fine-Tuning via Reinforcement Learning with Human Feedback (RLHF) Christiano et al. [2017], Ziegler et al. [2019], Stiennon et al. [2020], Ouyang et al. [2022] or AI Feedback (RLAIF) Lee et al. [2023] represent pivotal methods for enhancing downstream task performance in large language models. Each technique offers a unique approach to optimizing model proficiency: RAG integrates external knowledge sources during generation knowledge-intensive tasks like question answering, SFT adapts models to specific tasks through targeted training, and RLHF/RLAIF employs feedback-driven learning for iterative improvement. Among these, RLHF has shown notable success in aligning LLMs with human preferences, making it a focal point of study in this paper. 14Safety and risk considerations in LLMs. Large language models (LLMs) are typically trained on vast datasets sourced from the internet, encompassing a wide spectrum of content ranging from positive and neutral to negative and potentially toxic. Consequently, unaligned versions of LLMs have been documented to generate harmful content, as evidenced by recent studies Sheng et al. [2019], Wallace et al. [2019] which highlight the risks associated with uncurated training data. Furthermore, even aligned versions of LLMs are not immune to exploitation. The aligned models can still be prompted or ‘red-teamed’ to produce harmful content under certain conditions Gehman et al. [2020], Weidinger et al. [2021], Ganguli et al. [2022], Deshpande et al. [2023]. This underscores the complexity of mitigating risks in LLM deployment and the necessity for robust, ethical alignment strategies. Algorithmically including safety in LLM generations is a budding area of research. Bai et al. [2022a] demonstrated producing helpful and harmless content by doing RLHF with preference model trained on a mixture of helpful and harmless data. Solaiman and Dennison [2021] introduced PALMS, a method to iteratively finetune an LLM using a dataset that reflects a predetermined set of target values. The authors show that LLM behaviour can be significantly adjusted by finetuning on a small curated dataset. DExperts Liu et al. [2021] utilizes "expert" and "anti-expert" language models (LMs) to guide the generation process. There’s also the challenge of ensuring that the "expert" and "anti-expert" models are well-balanced, as any imbalance could lead to biased or skewed text generation. Moreover, there may be limitations in the granularity of control, particularly in nuanced or complex scenarios where the desired attributes of the text are not clearly defined or are subjective. The work by Liang et al. [2021] introduces Autoregressive INLP (A-INLP), for post-hoc debiasing of large pretrained language models. This method dynamically identifies bias-sensitive tokens and effectively mitigates bias while preserving contextual information in text generation. While it effectively mitigates bias in language models, the approach may not entirely eliminate biases. Furthermore, it focuses on biases identifiable through token-level interventions, which may not cover all types of biases. The paper also highlights the challenge of balancing bias mitigation with the retention of useful information in the model, indicating a potential trade-off between debiasing and model performance. Safe-RLHF Dai et al. [2023] balance helpfulness and harmlessness in AI responses by decoupling these aspects during training. Risk Averseness in RL. In the RL community, risk averseness to ensure safe policy execution has been studied using various risk criteria. Examples of these criteria include mean-variance, entropic and distortion risk measures Sato et al. [2001], La and Ghavamzadeh [2013], Prashanth and Ghavamzadeh [2016], Xie et al. [2018], Vijayan et al. [2021]. A more studied criterion is Conditional Value at Risk (CVaR), finding use in policy gradient Tamar et al. [2015], Rajeswaran et al. [2016], Hiraoka et al. [2019], Huang et al. [2021], value iteration Chow et al. [2015], and distributional RL Dabney et al. [2018], Tang et al. [2019], Bodnar et al. [2019]. A significant advancement in this domain is the introduction of the CeSOR algorithm by Greenberg et al. [2022], which presents a practical approach for risk-averse policy optimization. CeSOR integrates two innovative concepts: a soft risk scheduling mechanism to navigate the local-optimum challenges inherent in conventional risk-averse RL methods, and a cross-entropy module for enhanced sampling efficiency that still retains risk aversion. This approach allows for sampling episodes under poor conditions, and optimizing for successful strategies. Our research draws inspiration from this work, applying an adapted risk schedule to instill risk aversion in RLHF. D Data Analysis D.1 Datasets For IMDB-Gen, we make use of the IMDB dataset which contains a large collection of movie reviews. These reviews are labeled as either positive or negative. There are a total of 25k train and test reviews each. The dataset used for Jigsaw-Gen originates from a 2017 Kaggle competition focused on classifying Wikipedia talk page comments. Specifically, the data consists of human-labeled samples from a corpus compiled by Jigsaw (a subsidiary of Alphabet Inc.) and partners, where human raters identified multiple dimensions of toxicity including toxic, severely toxic, obscene, identity hate, threat, and insult. For constructing the task dataset, we sampled the original data to create a training set distribution of 70% non-toxic and 30% toxic data points and a test set containing 50% toxic and non-toxic points. Although the original corpus includes six hierarchical toxicity labels, the current study focuses solely on the presence or absence of the broad toxic class. The resulting dataset consists of 36, 973 training and 7, 708 test samples. 15D.2 Motivation for the choice of tasks In addition to requiring deeper level of language understanding and generation capability, transforming classification tasks into generative tasks makes them potentially more powerful and versatile in their applications. The model now needs to not only analyze and understand the input text, but, also creatively generate appropriate and contextually relevant content while maintaining the original message or sentiment. This could be used to understand how a review might evolve based on its beginning, or to generate examples of different types of sentiment expressions for training or analysis purposes. This can have practical applications in enhancing user experience and safety on various digital platforms. D.3 IMDB D.3.1 Scores (Environment rewards) distribution Analysis of test dataset. Here, full reviews that are assigned positive sentiment in the dataset belong to Class 1. Similarly, full reviews that are marked as having negative sentiment belong to Class 0. Only 16 of the prompts belonging to the true Class 1 were scored below −2.8. A total of 1806 of Class 0 prompts were below a score of −2.8. 3  2  1  0 1 2 3 Enviroment Score 0 250 500 750 1000 1250 1500 1750No. of input prompts Positive Negative (a) Scores for all train prompts 3.10  3.05  3.00  2.95  2.90  2.85  2.80 Enviroment Score 0 20 40 60 80 100No. of input prompts Positive Negative (b) Scores for tail train prompts Figure 6: Scores for train prompts of size 200 characters (∼ 64 tokens) for IMDB review dataset. 3  2  1  0 1 2 3 Enviroment Score 0 250 500 750 1000 1250 1500 1750No. of input prompts Positive Negative (a) Scores for all test prompts 3.10  3.05  3.00  2.95  2.90  2.85  2.80 Enviroment Score 0 20 40 60 80 100No. of input prompts Positive Negative (b) Scores for tail test prompts Figure 7: Scores for test prompts of size 200 characters (∼ 64 tokens) for IMDB review dataset. D.3.2 Critical prompt clusters We perform k-means cluster analysis on the embedding for prompts from the previous section that get a score less than -2.8. We use a total of 167 (150 from Class 0 and 17 from Class 1) prompts for this analysis. We use EleutherAI/gpt-j-6b model available on Huggingface model repository to generate embeddings. We then group these embeddings into 8 clusters using 16Table 6: Sample IMDB test prompts from the tail of score distribution. Class Score Review Category 0 -2.80 I have seen about a thousand horror films. (my favorite type) This film is among the worst. For me, an idea drives a movie. So, even a poorly acted, cheaply made movie can be good. Something Weird is Contrasting Different Critical Opinions 0 -2.80 Movie industry is tricky business - because decisions have to be made and everyone involved has a private life, too. That’s the very original thesis of this feeble attempt at making an ’insightful’ fi Interpreting Ambiguous or Symbolic Content 0 -3.05 The premise of this movie was decent enough, but with sub par acting, it was just bland and dull.<br /><br />SPOILERS The film does not work because of the nature of the death, it was accidental, so a Technical Aspects of Filmmaking 0 -2.82 I’m a Christian who generally believes in the theology taught in Left Behind. That being said, I think Left Behind is one of the worst films I’ve seen in some time. To have a good movie, yo Sarcasm or Subtle Hu- mor 0 -2.83 I finally got to have a look at this experimental Lynch short after waiting for so long....and unfortunately, it wasn’t worth it! Even for a die hard Lynch fan, I found this to be really tedious.... Interpreting Ambiguous or Symbolic Content 1 -2.93 OK, so the musical pieces were poorly written and gen- erally poorly sung (though Walken and Marner, par- ticularly Walken, sounded pretty good). And so they shattered the fourth wall at the end by having Technical Aspects of Filmmaking 1 -2.88 On paper, this movie would sound incredibly boring. The idea of a 75-year-old man traveling the country-side on a riding mower certainly doesn’t have much appeal to it, but the real power behind the f Complex and Nuanced Critique 1 -2.81 Johnny Dangerously falls completely in the hit or miss category with it’s overblown gags and complete lack of a comprehensive script or story that makes ANY sense. But that’s the point, right? Culturally Specific Ref- erences sklearn.cluster.KMeans. We then project these clusters into 2-dimensional (2D) space for visu- alization using sklearn.decomposition.PCA. The clusters visualized in 2D are included in Fig. 8. 20  10  0 10 20 y 20 10 0 10 20 x Cluster 0 Cluster 1 Cluster 2 Cluster 3 Cluster 4 Cluster 5 Cluster 6 Cluster 7 Figure 8: Scores for test prompts of size 200 characters (∼ 64 tokens) for IMDB review dataset. Here, we include a few reviews from each of the clusters. On a coarse qualitative self analysis, reviews from cluster-0 are reviews that criticize the movie in a nicer tone. Reviews in cluster-1 are a plain expression of dislike along, and comment about technical details in the moving making process. 17Reviews from cluster-2 focus on poor movie adaptation. Cluster-3 reviews belong to movies that can be broadly classified as ’Fiction’. Cluster-4 reviews describe movies as ‘absolute garbage’. It is hard to put pin on one qualitative attribute for cluster-5. Cluster-6 reviews describe movies as having ‘terrible story’ and ‘bad acting’. The reviews in Cluster-7 focus on bad acting. Reviews from cluster-0: A. I expected alot from this movie. Kinda like Lee as a Naustradamous like caracter but instead all I got was a waste of time and a boring movie. I can’t even explain this movie. It had wooden acting, te B. I really wish i could give this a negative vote, because i think i just wasted 83 minutes of my life watching the worst horror movie ever put to film. the acting was just god awful, i mean REALLLYYYY C. I usually try to be professional and constructive when I criticize movies, but my GOD!!! This was THE worst movie I have ever seen. Bad acting, bad effects, bad script, bad everything! <br /><br />The Reviews from Cluster 1: A. this movie was a horrible excuse for...a movie. first of all, the casting could have been better; Katelyn the main character looked nothing like her TV mom. <br /><br />also, the plot was pathedic. it B. This film is awful. The CGI is the very cheap gray blob CGI. The crocodile looks like a large gray smudge. The worst is that no effort at all is given to making it walk or look like it is alive. It is C. This is, without doubt, one of the worst films I’ve ever seen...<br /><br />The plot is so full of holes, the story is like a bad remake of a bad suspense movie and the actors sound like were reading Reviews from Cluster 2: A. One of the worst movies I’ve ever seen. Acting was terrible, both for the kids and the adults. Most to all characters showed no, little or not enough emotion. The lighting was terrible, and there were B. One of the worst movies I’ve seen shoddy camera work, crappy filter usage, film was grainy, script was terrible, i mean come on, how predictable was the big battle at the end.....<br /><br />some of t C. One of the worst movies I ever saw. My only thought was: "how can I get my money back from Hollywood Video". This is no way worth four dollars, or any dollars. I think it was an attempt to rip off The Reviews from Cluster 3: A. Terrible film made on a budget of about 9.99. Very obvious miniature sets used, poor acting and an awful storyline concerning aliens who use discarded meat from a butcher shop as fuel for their space B. Terrible use of scene cuts. All continuity is lost, either by awful scripting or lethargic direction. That villainous robot... musta been a jazz dancer? Also, one of the worst sound tracks I’ve ever h Reviews from Cluster 4: A. Absolute garbage, worse fight scenes than a 20 year old van damme movie or American ninja etc.<br /><br />Truly dire acting, not a skill in sight in the entire movie its like a cast of wooden sculptur B. Absolute garbage. The reason that this is so terrible is not because it deviated from the formula, but because the plot was just pathetic. <br /><br />The supposed star didn’t do anything to solve the 18Reviews from Cluster 5: A. Truly terrible, pretentious, endless film. Director Bellocchio seems to be infatuated with the pretty face and figure of his actress Detmers - and who can blame him? But maybe, just maybe, he should h B. Cheap and mind-blisteringly dull story and acting. Not a single good line, not even a line bad enough to be good, and no memorable delivery. Even the blooper reel included with the DVD showed how inep C. ATTENTION, SPOILER! Many people told me that Planet of the Apes was Tim Burton’s worst movie and apart from that much weaker than the original film. So I decided not to see it. Another fr Reviews from Cluster 6: A. Okay, let’s face it. this is a god-awful movie. The plot (such as it is) is horrible, the acting worse. But the movie was made for one reason and one reason only, like all of those awful Mario Lanza m B. Absolutely one of the worst movies of all time.<br /><br />Low production values, terrible story idea, bad script, lackluster acting... and I can’t even come up with an adjective suitably descriptive C. OK, so the musical pieces were poorly written and generally poorly sung (though Walken and Marner, particularly Walken, sounded pretty good). And so they shattered the fourth wall at the end by having Reviews from Cluster 7: A. After reading the other reviews for this film I am of the opinion that the high markers are probably paid studio lackeys as the film I saw was absolutely dire, with wooden acting, lacklustre scripting B. The only redeeming quality of this film is the actual storyline...Otherwise, this movie was terrible. The acting was ridiculously bad, and the set design was cheesy and very tacky. The story was decen C. All the bare chested women in the world couldn’t keep me from hitting the stop button about a third of the way through this awful rubbish. With the derisory acting, equally terrible script plus the po D.4 Jigsaw D.4.1 Scores (Environment rewards) distribution Environment reward distribution for Jigsaw train and test datasets is included in Fig. 9 and Fig. 10. 6  4  2  0 2 4 6 8 Enviroment Score 0 2000 4000 6000 8000 10000 12000 14000No. of input prompts Non-toxic T oxic (a) Scores for all train prompts 7.0  6.5  6.0  5.5  5.0 Enviroment Score 0 20 40 60 80 100 120 140No. of input prompts Non-toxic T oxic (b) Scores for tail train prompts Figure 9: Scores for train prompts of size 60 characters (∼ 20 tokens) for Jigsaw dataset. 196  4  2  0 2 4 6 8 Enviroment Score 0 250 500 750 1000 1250 1500 1750No. of input prompts Non-toxic T oxic (a) Scores for all test prompts 7.0  6.5  6.0  5.5  5.0 Enviroment Score 0 5 10 15 20 25 30 35 40No. of input prompts Non-toxic T oxic (b) Scores for tail test prompts Figure 10: Scores for test prompts of size 60 characters (∼ 20 tokens) for Jigsaw dataset. D.4.2 Critical prompt clusters We perform clustering on the critical prompts from the Jigsaw dataset, similar to the analysis done for IMDB. We observe that two out of the three sampled prompts from Cluster-0 seem to be referring to Wikepedia. Cluster-1 seems to have some clutural and pop references like the dance form ‘dabke’ and the word ‘nerd’. Cluster-2 has prompts where posters seem to take pride in being able to post negative content irrespective of possible censorship by specific platform. There seem to be generic toxic prompts in Cluster-3. The prompts in Cluster-4 seem to have negative sexual connotation. Cluster-5 prompts seem to have toxicity towards certain social and political groups. Cluster-6 seems to have toxicity towards certain social groups like Jews and Blacks. Cluster-7 prompts, again, have toxicity towards social groups like Blacks. 20  10  0 10 20 30 y 20 10 0 10 20 30 40 50 x Cluster 0 Cluster 1 Cluster 2 Cluster 3 Cluster 4 Cluster 5 Cluster 6 Cluster 7 Figure 11: Clustering on Jigsaw test dataset. Reviews from Cluster 0: A. == AfD == Go suck a fuck. ::Okay, what the B. ==Hay fuck head== What r u some kind of wikipedia cop? Yur a C. == Wikipedia == Wikipedia was created by raging faggots who loved to bum fuck each other Reviews from Cluster 1: A. U R ALL FUCKING NERDS AND U NEED TO DIE!!!!!Media:Example.ogg B. Hahaha Go fuck yourself Roland. Why are you denying that Dabke is a dance danced Reviews from Cluster 2: A. fuck u all hahahahaha I can still vandalize this page fuck u all hahahah B. fuck you bitches i use a proxy and i can do whatever i want without getting in trouble so 20C. fuck you, you mother fucking son of a bitch. i am gooing to kill you in your Reviews from Cluster 3: A. hellonyeah == Shut up, bitch. You Involved in my B. " WHEN I AM UNBLOCKED I SWEAR I WILL GO F**K YOUR M C. "::""Fuck you"" seconded...er wait, Geppy. I don’t Review from Cluster 4: A. Fuck you I won’t do what they tell me Fuck you I won’t do what Reviews from Cluster 5: A. i hate black poeple...mia coleman is a bitchhhhhhhhhhhhhhhhhhhhhhhhh B. it was a very fucking good comment so dont sweat it bro fuckit right in the loose goose po C. RL should fuck off to America to be with all the other fat nazi twats. Reviews from Cluster 6: A. He thinks it’s fucking hilarious you fell for him when you were letting him spin so much shit and B. So typical of the arrogance of you vile anti-Semites. You filthy piece of shit. C. I agree dude you should fuckin change shit. Nasir Jones my nigs Reviews from Cluster 7: A. look dobnt talk shit about martin hes da best you fukin ass whipe mother B. big black men that want to stick hitler in his ass with thier huge 24 inch dicks C. because the world found out and they did not want a president that fucked his sister E RA-RLHF Implementation E.1 Models and Compute For our experiments with both the datasets, we use the model GPT2 (117 million parame- ters, 0.5 GigaBytes (GB)) as our LLM policy. We adapt the RLHF and SFT implementa- tions available on the Hugging Face transfomer reinforcement learning (TRL) repository 4 to our datasets. We implement RA-RLHF starting from this existing RLHF implementation. The AutoModelForCausalLMWithValueHead class provides functionality to attach a Value head to the GPT2 model with an existing LMHeadModel (see Listing 2 in the Appendix). The vocabulary size |A| = 50257. The tokenizer ( GPT2TokenizerFast) specifications for GPT2 model are included in Listing 3. For IMDB task, we use lvwerra/distilbert-imdb as the reward model. It is available on Hugging Face model repository5. The model specifications and corresponding tokenizer (DistilBertTokenizerFast) specifications are included in Listings 4 and 5, respectively. For Jigsaw-Gen we use (unitary/toxic-bert) as the reward model; also available on Hugging Face model repository. This model achieves an AUC metric of 0.98 on the Kaggle Challenge. Speccifica- tions of this reward model and it’s tokenizer are included in Listings 6 and 7 respectively. Our codes were run on machines with GPU configurations of NVIDIA Tesla V100 SXM2 32 GB, and NVIDIA A100 80 GB. Average run time across algorithms is 52 minutes. 4https://github.com/huggingface/trl 5https://huggingface.co/models 21E.2 Proximal Policy Optimization Consider a batch of three episodes, i.e., three pairs of input prompts and output generations. batch = Input prompt Generation x11 x12 − x14 x15 x16 x21 x22 x23 x24 x25 x26 x31 x32 x33 x34 x35 − (9) This batch is then processed to obtain the appropriate padded episodes of the form: padded batch = Input prompt Generation x11 = pad x 12 x13 x14 x15 x16 x21 x22 x23 x24 x25 x26 x31 x32 x33 x34 x35 x36 = pad (10) Note that at time step i, logits returned by LMHead are for the next tokens i + 1. # logits[:, 0, :] is for input_ids[:, 1] logprobs = logprobs_from_logits(logits[:, :-1, :], input_ids[:, 1:]) Then, batched_forward_pass() method takes this padded batch and outputs mask m(xi+1), log πθ(xi+1|si) and V (si) for each i = 1, .., T− 1 in an episode: log probabilities = Input prompt Generation lp12 lp13 lp14 lp15 lp16 lp22 lp23 lp24 lp25 lp26 lp32 lp33 lp34 lp35 lp36 (11) Values = Input prompt Generation V11 V12 V13 V14 V15 V21 V22 V23 V24 V25 V31 V32 V33 V34 V35 (12) masks = Input prompt Generation m12 = 0 m13 = 0 m14 = 1 m15 = 1 m16 = 1 m22 = 0 m23 = 0 m24 = 1 m25 = 1 m26 = 1 m32 = 0 m33 = 0 m34 = 1 m35 = 1 m36 = 0 (13) These per-token log probabilities, Values and masks are then sent to compute_rewards() method to obtain per-token total reward ( i.e., ¯r(si, xi+1) = r(si, xi+1) − β(log πθ(xi+1|si) − log πref (xi+1|si))) and per-token non-score-reward ( i.e., β · kl(xi+1) = β · (log πθ(xi+1|si) − log πref (xi+1|si))) for each i = 1, .., T− 1 in an episode. Non score reward = Input prompt Generation β · kl12 β · kl13 β · kl14 β · kl15 β · kl16 β · kl22 β · kl23 β · kl24 β · kl25 β · kl26 β · kl32 β · kl33 β · kl34 β · kl35 β · kl36 (14) Total reward = Input prompt Generation β · kl12 β · kl13 β · kl14 β · kl15 β · kl16 + r(s15, x16) β · kl22 β · kl23 β · kl24 β · kl25 β · kl26 + r(s15, x16) β · kl32 β · kl33 β · kl34 β · kl35 + r(s14, x15) β · kl36 (15) 22Then, Advantages are computed using Generalized Advantage Estimation (GAE) in the method compute_advantages(). This method takes masked total reward and masked Values to perform the GAE operation. The Calculated advantages are then whitened only for the non-masked indices. Now that we have everything we need to calculate loss for training our LM policy using policy gradients. Value Function Loss Calculation A. Value Prediction Clipping: The predicted values (vpreds) are clipped within a specified range around the current values (values). The range is determined by self.config.cliprange_value. B. Value Function Losses: Two types of losses are calculated: (1) vf_losses1 - The squared difference between predicted values and true returns, (2)vf_losses2 - The squared difference between clipped predicted values and true returns. C. Final Value Function Loss ( vf_loss): It’s the mean of the maximum of vf_losses1 and vf_losses2, masked by mask. Policy Gradient Loss Calculation A. Ratio: This is the exponentiated difference between new log probabilities (logprobs) and old log probabilities (old_logprobs). B. Policy Gradient Losses: Two types of losses are calculated: (1) pg_losses - The product of negative advantages and the ratio, (2) pg_losses2 Product of negative advantages and the clamped ratio. C. Final Policy Gradient Loss ( pg_loss): It’s the mean of the maximum of pg_losses and pg_losses2, masked by mask. The total loss is a combination of the policy gradient loss and the value function loss, scaled by a coefficient (self.config.vf_coef). E.3 Training Hyperparameters The following is a list of hyperparameters used for PPO training. Any parameter not mentioned here was set to the default parameter generated by Hugging Face’s PPOConfig object. Table 7: RLHF Hyperparameters Hyperparameter IMDB-Gen Jigsaw-Gen Learning rate 1.41e − 05 1 .41e − 05 No. of iterations (M) 194 288 PPO epochs 4 4 No. of gradient steps 776 1 , 152 Batch size 128 128 KLtarget 6.0 6 .0 Initial β 0.2 0 .2 Kβ 0.0128 0 .0128 In addition to the above, RA-RLHF introduces the following additional hyperparameters F Extended Experimentation F.1 Risk Scheduler Analysis Fig. 12 includes multiple risk schedules studied in our work. 23Table 8: RA-RLHF Hyperparameters Hyperparameter IMDB-Gen Jigsaw-Gen Risk level, α 40% 20% Warm start, n 30 30 ρ 0.95 0 .95 0 40 80 120 160 200 Iterations 40 80 120Batch Size n = 30, alpha = 0.4, rho = 0.95 n = 1, alpha = 0.4, rho = 0.95 n = 30, alpha = 0.3, rho = 0.95 n = 30, alpha = 0.2, rho = 0.95 Figure 12: IMDB risk schedule analysis F.2 Other training statistics In Fig. 13 and Fig. 14, we include plots to shed more light on how various parameters vary during the RLHF and RA-RLHF training. 0 100 200 Training iteration 0.0 0.5 1.0 1.5Environment Reward RA-RLHF RLHF (a) IMDB-Gen 0 100 200 Training iteration 1.5 1.6 1.7 1.8 1.9 2.0Reward std RA-RLHF RLHF (b) IMDB-Gen 0 100 200 Training iteration 0.20 0.22 0.24 0.26 0.28Beta RA-RLHF RLHF (c) IMDB-Gen 0 100 200 Training iteration 0 2 4 6 8KL Divergence RA-RLHF RLHF (d) IMDB-Gen Figure 13: Various training statistics for IMDB-Gen. 0 100 200 300 Training iteration 5.25 5.50 5.75 6.00 6.25Environment Reward RA-RLHF RLHF (a) Jigsaw-Gen 0 100 200 300 Training iteration 2.8 3.0 3.2 3.4 3.6 3.8Reward std RA-RLHF RLHF (b) Jigsaw-Gen 0 100 200 300 Training iteration 0.20 0.25 0.30Beta RA-RLHF RLHF (c) Jigsaw-Gen 0 100 200 300 Training iteration 0.0 2.5 5.0 7.5 10.0 12.5KL Divergence RA-RLHF RLHF (d) Jigsaw-Gen Figure 14: Various training statistics for Jigsaw-Gen F.3 GPT-J 6B To investigate the scalability of our algorithm with larger models, we extend our experiments to include GPT-J, an open-source language model developed by EleutherAI. GPT-J has a substantial architecture with approximately 6 billion tunable parameters, representing a significant step up in complexity and capacity compared to the GPT-2 previously evaluated. However, the task of fine-tuning a model of GPT-J’s magnitude presents considerable challenges, primarily due to the computational expense and the extensive data requirements associated with adjusting such a vast number of parameters. To mitigate these challenges, we used a sharded 24model6 with bfloat16 floating-point precision available on huggingface’s model hub and employed Low-Rank Adaptation (LoRA) Hu et al. [2021] as a strategic approach to parameter tuning. LoRA introduces a low-rank decomposition of the weight matrices in transformer models, enabling effective fine-tuning by only adjusting a small subset of the model’s parameters. Even when using the model in bfloat16 floating-point precision and with LoRA, we run into out-of-memory (OOM) errors on attempting to perform RLHF on the model because of storage needed for gradients, forward activations, temporary memory, data and functionality specific memory. Therefore, we use a supervised fine tuned GPT2 model as the reference model to reduce memory footprint. Additionally, we use a considerably smaller batch size of 8 to ensure smooth running of experiments. The GPT-J experiments take over24 hrs to finish one epoch over the IMDB dataset while running on a Tesla V100 32GB GPU. With a server imposed 24 hour time limit on the GPU usage, this results in that the models parsing through only 70% of the train dataset. We include the results from our experiments on finetuning GPT-J on IMDB-Gen task in Fig. 15 and Table 9. RA-RLHF again demonstrates the best performance over average reward (measure of preference), average reward over input prompt quantiles (measure of risk-averseness), and visual reward distribution shift of environment rewards obtained from SFT, RLHF and RA-RLHF. This can likely be attributed to the RA-RLHF model undertaking slightly aggressive adjustments to satisfy the goals of sentiment modification. F.3.1 Results for IMDB-Gen (on GPT-J) 2.5  0.0 2.5 Reward 0 200 400Count Prompt Score Not Offensive Offensive 2.5  0.0 2.5 Reward 0 200 400 SFT Not Offensive Offensive 2.5  0.0 2.5 Reward 0 200 400 RLHF Not Offensive Offensive 2.5  0.0 2.5 Reward 0 200 400 RA-RLHF Not Offensive Offensive 0 50 100 Quantile (%) 3 2 1 0 1 Average Reward Reward vs Quantile GPT2 GPTJ SFT RLHF RA-RLHF Figure 15: Environment reward distribution shift, and quantile plot for IMDB-Gen. Table 9: Testing on reward (r), and Perplexity. For average reward calculation, test samples from both positive and negative classes are used. For perplexity calculations, only positive class samples are used. Results are for one seed. IMDB (GPT-J) Model Reward (r) ↑ Tail (r) ↑ Perplexity ↓ GPT2 −0.04 −2.59 43 .87 GPTJ −0.06 −2.67 21 .58 SFT 0.11 −2.47 39 .57 RLHF 1.01 −1.51 22 .13 RA-RLHF (Ours) 1.24 −1.11 23 .03 F.4 RealToxicityPrompts-Gen To explore how our algorithm works on larger sized datasets, we add another task based on the RealToxicityPrompts dataset. Results for the same are included in Fig. 16 and Table 10. RealToxicityPrompts-Gen task has a training size of 57.9k prompts compared to IMDB’s 25k and Jigsaw’s 36.9k. The dataset utilized in this task is introduced by Gehman et al. Gehman et al. [2020]. This dataset originates from the OPEN-WEBTEXT CORPUS, a comprehensive corpus of English web text compiled from outbound URLs referenced on Reddit. The creators of the Real- ToxicityPrompts dataset utilized Perspective API to assign toxicity scores to sentences within the corpus, facilitating the evaluation of prompt toxicity. To ensure a broad spectrum of toxicity within 6https://huggingface.co/ybelkada/gpt-j-6b-sharded-bf16 25the prompts, 25, 000 sentences were sampled from four toxicity ranges, each covering a quarter of the toxicity spectrum (i.e., [0, .25), [.25, .50), [.50, .75), and [.75, 1]), culminating in a total of 100, 000 sentences. These sentences were subsequently bifurcated, generating a distinct prompt and continuation for each. For the construction of the RealToxicityPrompts-Gen task, the original dataset prompts are sampled to establish a training set composed of 70% non-toxic and 30% toxic data points, alongside a test set featuring an equal distribution of 50% toxic and 50% non-toxic points. The demarcation for toxic versus non-toxic classification was set at a Perspective API score of 0.5. Consequently, the derived dataset encompasses 57, 983 samples for training purposes and 8, 698 samples for testing. For the task, we prompt the LLMs with 32 tokens and expect it to generate a continuation of an additional 32 tokens. Average run time for the RealToxicity-Gen task on a Tesla V100 32 GB GPU is 1 hr 43 mins, 51 mins more than average run time over the other two datasets. F.4.1 Results for RealToxicityPrompts-Gen (on GPT-2) 5  0 5 Reward 0 500 1000 1500 2000Count Prompt Score 4  0 40 50 100 150 Non T oxic T oxic 5  0 5 Reward 0 500 1000 1500 2000 SFT 4  0 40 50 100 150 Non T oxic T oxic 5  0 5 Reward 0 500 1000 1500 2000 RLHF 4  0 40 50 100 150 Non T oxic T oxic 5  0 5 Reward 0 500 1000 1500 2000 RA-RLHF 4  0 40 50 100 150 Non T oxic T oxic 0 50 100 Quantile (%) 5.0 2.5 0.0 2.5 5.0 Average Reward Reward vs Quantile 2 4 5.0 4.5 GPT2 SFT RLHF RA-RLHF Figure 16: Environment reward distribution shift, and quantile plot for RealToxicityPrompts-Gen. Table 10: Testing on reward (r), and Perplexity. For average reward calculation, test samples from both positive and negative classes are used. For perplexity calculations, only positive class samples are used. Results are for one seed. RealToxicityPrompts Model Reward (r) ↑ Tail (r) ↑ Perplexity ↓ GPT2 3.58 1 .62 174 .11 SFT 3.15 1 .21 122 .79 RLHF 4.29 2 .44 147 .26 RA-RLHF (Ours) 4.58 2 .83 155 .23 G Perplexity calculation We calculate perplexity using Huggingface’s evaluate 7 module. A call to the module using perplexity.evaluate() calculates perplexity using a sliding window strategy as described in the Huggingface’s blog onPerplexity of fixed-length models8. The main code for this function is included in Listing 1. 7https://github.com/huggingface/evaluate/blob/main/metrics/perplexity/perplexity.py 8https://huggingface.co/docs/transformers/perplexity 26Listing 1: Perplexity caculation in Huggingface’s evalute module for start_index in logging.tqdm(range(0, len(encoded_texts), batch_size)): end_index = min(start_index + batch_size, len(encoded_texts)) encoded_batch = encoded_texts[start_index:end_index] attn_mask = attn_masks[start_index:end_index] if add_start_token: bos_tokens_tensor = torch.tensor([[tokenizer.bos_token_id]] * encoded_batch .size(dim=0)).to(device) encoded_batch = torch.cat([bos_tokens_tensor, encoded_batch], dim=1) attn_mask = torch.cat( [torch.ones(bos_tokens_tensor.size(), dtype=torch.int64).to(device), attn_mask], dim=1 ) labels = encoded_batch with torch.no_grad(): out_logits = model(encoded_batch, attention_mask=attn_mask).logits shift_logits = out_logits[..., :-1, :].contiguous() shift_labels = labels[..., 1:].contiguous() shift_attention_mask_batch = attn_mask[..., 1:].contiguous() perplexity_batch = torch.exp( (loss_fct(shift_logits.transpose(1, 2), shift_labels) * shift_attention_mask_batch).sum(1) / shift_attention_mask_batch.sum(1) ) ppls += perplexity_batch.tolist() 27Listing 2: Model specifications for GPT2 for language generation AutoModelForCausalLMWithValueHead( (pretrained_model): GPT2LMHeadModel( (transformer): GPT2Model( (wte): Embedding(50257, 768) (wpe): Embedding(1024, 768) (drop): Dropout(p=0.1, inplace=False) (h): ModuleList( (0-11): 12 x GPT2Block( (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True) (attn): GPT2Attention( (c_attn): Conv1D() (c_proj): Conv1D() (attn_dropout): Dropout(p=0.1, inplace=False) (resid_dropout): Dropout(p=0.1, inplace=False) ) (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True) (mlp): GPT2MLP( (c_fc): Conv1D() (c_proj): Conv1D() (act): NewGELUActivation() (dropout): Dropout(p=0.1, inplace=False) ) ) ) (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True) ) (lm_head): Linear(in_features=768, out_features=50257, bias=False) ) (v_head): ValueHead( (dropout): Dropout(p=0.1, inplace=False) (summary): Linear(in_features=768, out_features=1, bias=True) (flatten): Flatten(start_dim=1, end_dim=-1) ) ) Listing 3: GPT2 tokenizer specifications GPT2TokenizerFast( name_or_path=’lvwerra/gpt2-imdb’, vocab_size=50257, model_max_length=1024, is_fast=True, padding_side=’right’, truncation_side=’right’, special_tokens={’bos_token’: ’<|endoftext|>’, ’eos_token’: ’<|endoftext|>’, ’unk_token’: ’<|endoftext|>’}, clean_up_tokenization_spaces=True ), added_tokens_decoder={ 50256: AddedToken("<|endoftext|>", rstrip=False, lstrip=False, single_word=False, normalized=True, special=True),} 28Listing 4: Model specifications for IMDB-Gen reward model DistilBertForSequenceClassification( (distilbert): DistilBertModel( (embeddings): Embeddings( (word_embeddings): Embedding(30522, 768, padding_idx=0) (position_embeddings): Embedding(512, 768) (LayerNorm): LayerNorm((768,), eps=1e-12, elementwise_affine=True) (dropout): Dropout(p=0.1, inplace=False) ) (transformer): Transformer( (layer): ModuleList( (0-5): 6 x TransformerBlock( (attention): MultiHeadSelfAttention( (dropout): Dropout(p=0.1, inplace=False) (q_lin): Linear(in_features=768, out_features=768, bias=True) (k_lin): Linear(in_features=768, out_features=768, bias=True) (v_lin): Linear(in_features=768, out_features=768, bias=True) (out_lin): Linear(in_features=768, out_features=768, bias=True) ) (sa_layer_norm): LayerNorm((768,), eps=1e-12, elementwise_affine=True) (ffn): FFN( (dropout): Dropout(p=0.1, inplace=False) (lin1): Linear(in_features=768, out_features=3072, bias=True) (lin2): Linear(in_features=3072, out_features=768, bias=True) (activation): GELUActivation() ) (output_layer_norm): LayerNorm((768,), eps=1e-12, elementwise_affine=True ) ) ) ) ) (pre_classifier): Linear(in_features=768, out_features=768, bias=True) (classifier): Linear(in_features=768, out_features=2, bias=True) (dropout): Dropout(p=0.2, inplace=False) ) 29Listing 5: IMDB-Gen reward model tokenizer specifications DistilBertTokenizerFast( name_or_path=’lvwerra/distilbert-imdb’, vocab_size=30522, model_max_length=512, is_fast=True, padding_side=’right’, truncation_side=’right’, special_tokens={’unk_token’: ’[UNK]’, ’sep_token’: ’[SEP]’, ’pad_token’: ’[PAD]’, ’cls_token’: ’[CLS]’, ’mask_token’: ’[MASK]’}, clean_up_tokenization_spaces=True ), added_tokens_decoder={ 0: AddedToken("[PAD]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), 100: AddedToken("[UNK]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), 101: AddedToken("[CLS]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), 102: AddedToken("[SEP]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), 103: AddedToken("[MASK]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), } 30Listing 6: Model specifications for Jigsaw-Gen reward model BertForSequenceClassification( (bert): BertModel( (embeddings): BertEmbeddings( (word_embeddings): Embedding(30522, 768, padding_idx=0) (position_embeddings): Embedding(512, 768) (token_type_embeddings): Embedding(2, 768) (LayerNorm): LayerNorm((768,), eps=1e-12, elementwise_affine=True) (dropout): Dropout(p=0.1, inplace=False) ) (encoder): BertEncoder( (layer): ModuleList( (0-11): 12 x BertLayer( (attention): BertAttention( (self): BertSelfAttention( (query): Linear(in_features=768, out_features=768, bias=True) (key): Linear(in_features=768, out_features=768, bias=True) (value): Linear(in_features=768, out_features=768, bias=True) (dropout): Dropout(p=0.1, inplace=False) ) (output): BertSelfOutput( (dense): Linear(in_features=768, out_features=768, bias=True) (LayerNorm): LayerNorm((768,), eps=1e-12, elementwise_affine=True) (dropout): Dropout(p=0.1, inplace=False) ) ) ) ) (pooler): BertPooler( (dense): Linear(in_features=768, out_features=768, bias=True) (activation): Tanh() ) ) (dropout): Dropout(p=0.1, inplace=False) (classifier): Linear(in_features=768, out_features=6, bias=True) ) 31Listing 7: Jigsaw-Gen reward model tokenizer specifications BertTokenizerFast(name_or_path=’unitary/toxic-bert’, vocab_size=30522, model_max_length=512, is_fast=True, padding_side=’right’, truncation_side=’right’, special_tokens={’unk_token’: ’[UNK]’, ’sep_token’: ’[SEP]’, ’pad_token’: ’[PAD]’, ’cls_token’: ’[CLS]’, ’mask_token’: ’[MASK]’}, clean_up_tokenization_spaces=True ), added_tokens_decoder={ 0: AddedToken("[PAD]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), 100: AddedToken("[UNK]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), 101: AddedToken("[CLS]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), 102: AddedToken("[SEP]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), 103: AddedToken("[MASK]", rstrip=False, lstrip=False, single_word=False, normalized=False, special=True), } 32NeurIPS Paper Checklist A. Claims Question: Do the main claims made in the abstract and introduction accurately reflect the paper’s contributions and scope? Answer: [Yes] Justification: (a) Are the concepts of "risk" in RARL and the "safety" concerns of LMs the same? Yes, in reinforcement learning (RL), “risk” can mean both variability of costs and sen- sitivity to modeling errors, and the potential for rare but highly undesirable outcomes or tail events Greenberg et al. [2022]. The latter could involve catastrophic failures, substantial negative rewards, or entering unrecoverable states. These tail events repre- sent rare but potentially highly impactful negative outcomes that an RL system seeks to avoid. CVaR, the objective adapted in our work, as an objective possessing the “ability to safeguard a decision maker from the “outcomes that hurt the most”[Chow et al., 2015, Serraino and Uryasev, 2013]. This clarification underlines that the motivation for our work aligns with the foundational principles of RARL, aiming to enhance LLM safety through a nuanced understanding of "risk". (b) Do the experiments support the claims? In our submission, we conducted a com- prehensive evaluation of Large Language Models (LLMs) focusing on tasks related to sentiment modification and toxicity mitigation. This assessment utilized a diverse set of metrics to ensure a holistic understanding of model performance. Specifically, we measured: i. The average environment reward on test dataset to gauge toxicity mitigation. ii. The finetuned models’ performance across different input quality levels measured in quantiles with results included in Figures 1 and 2 (column 5). iii. The perplexity of input-output pairs, providing insight into the finetuned models’ generation quality. iv. Shifts in distribution, depicted through visual histograms in Figures 1 and 2 (columns 1-4), highlighting changes in model output characteristics. Our findings consistently show that the RA-RLHF model outperforms the standard RLHF approach across these evaluation metrics. While we observed a marginal increase in model perplexity for RA-RLHF, this can likely be attributed to the model undertaking more aggressive adjustments to satisfy the goals of sentiment modification and toxicity mitigation. Importantly, this increase in perplexity does not compromise model performance; in fact, the perplexity scores for Jigsaw-Gen remain lower than those recorded for the GPT-2 model, underscoring RA-RLHF’s superior performance in avoiding harmful outputs while maintaining effectiveness in generative tasks. (c) We would also like to point out that “safety” can take different representations in different applications. We optimize for performance on rare high stake events, making our approach of wider use in applications employing LLMs, beyond the tasks of safe text generation considered in our work. (d) What is the technical novelty of the work? Our work is the first to introduce a nuanced understanding of risk in the context of LLM content generation, going beyond Greenberg et al. [2022]’s work. Greenberg et al. [2022] proposed soft risk scheduling to make policies learned using policy gradients risk-averse. Presented below are our contributions: i. We implement CVaR in conjunction with a regularized reinforcement learning objective (reward + KL term). Greenberg et al. [2022] work only with the plain reward. We choose to work with regularized reward for two reasons: I. We want to measure risk in generations accounting for both the performance on the actual environment reward and the quality of language generation measured by KL- Divergence with respect to the reference policy. II. Our said choice makes our proposed algorithm downward compatible to the existing RLHF implementations. ii. We implement CVaR in the Actor-Critic setting, as opposed to policy gradients, with an aim to learn a complex parameterized policy (LLM) with an extremely large action space. 33iii. Beyond the immediate application of creating safer LLMs, this work contributes to the broader field of machine learning by demonstrating how risk measures like CVaR can be integrated into the training process of complex models like LLMs. Our work additionally establishes a groundwork for exploring additional risk measures and criteria, such as the Entropic Value at Risk (EVaR), in the context of LLM safety and uncertainty quantification. (e) How does the work compare against the works based on Helpful and Harmless (HH) metric? Our research introduces a nuanced perspective on inducing safety in large language model (LLM) outputs, even encompassing characterization of safety through dual-axis approach of assessing helpfulness and harmlessness independently Bai et al. [2022a], Ganguli et al. [2022]. The work by Bai et al. [2022a] introduces the concepts of helpfulness and harmlessness, noting best performance tradeoff on LLMs that were RLHFed with preference models (PM) trained on the combined HH dataset (see Fig. 1 in Bai et al. [2022a]). They mention “fortunately, we find that PMs trained on a mixture of both datasets can nevertheless learn the right lessons and behave helpfully when appropriate, while encouraging the polite refusal of harmful requests”. In both Bai et al. [2022a], Ganguli et al. [2022], characterization of safety is done through a single reward/preference model, as is the case in our work. We, in fact, demonstrate in our work how the RLHF finetuning process can be made risk-averse using risk averse principles, algorithmically going beyond what is established in Bai et al. [2022a], Ganguli et al. [2022]. More recently, the work by Dai et al. [2023] introduces Safe-RLHF requiring separate models to evaluate the helpfulness and harmlessness of responses. This dual-model framework adds complexity to the safety induction process, necessitating the manage- ment of two distinct assessment criteria. In contrast, as mentioned above, we work with a single reward model. This singular reward-based framework is particularly ad- vantageous when the reward model is tuned to accurately reflect safety considerations specific to the task at hand. Under such circumstances, RA-RLHF can effectively navi- gate the safety landscape, ensuring that LLM generations meet the desired standards without the need for dual evaluations. This consolidation into a single reward model offers a more efficient and potentially more effective mechanism for achieving safe and reliable LLM outputs across broader applications. B. Limitations Question: Does the paper discuss the limitations of the work performed by the authors? Answer: [Yes] Justification: We include Limitations in Appendix A because of space constraints in the main paper. We tested our approach on three datasets of varying sizes and properties (see Tasks paragraph in Sec. 5, Sec. D and Sec. F.4 in Appendix). We worked with two different Large Language Models (LLMs): GPT2 (117M; see Sec. 5) and GPT-J 6B (see Sec. F.3). Compute requirements, and run times are appropriately included in Sections E.1, and F.3 in Appendix. C. Theory Assumptions and Proofs Question: For each theoretical result, does the paper provide the full set of assumptions and a complete (and correct) proof? Answer: [NA] Justification: The paper presents an empirical approach to inducing risk-averseness in LLMs. D. Experimental Result Reproducibility Question: Does the paper fully disclose all the information needed to reproduce the main ex- perimental results of the paper to the extent that it affects the main claims and/or conclusions of the paper (regardless of whether the code and data are provided or not)? Answer: [Yes] Justification: Our codebase is available in an anonymous Github repository, and further implementation details are included in Appendix E. E. Open access to data and code 34Question: Does the paper provide open access to the data and code, with sufficient instruc- tions to faithfully reproduce the main experimental results, as described in supplemental material? Answer: [Yes] Justification: Our codebase is available in an anonymous Github repository, and further implementation details are included in Appendix E. F. Experimental Setting/Details Question: Does the paper specify all the training and test details (e.g., data splits, hyper- parameters, how they were chosen, type of optimizer, etc.) necessary to understand the results? Answer: [Yes] Justification: We tested our approach on three datasets of varying sizes and properties (see Tasks paragraph in Sec. 5, Sec. D and Sec. F.4 in Appendix). We worked with two different Large Language Models (LLMs): GPT2 (117M; see Sec. 5) and GPT-J 6B (see Sec. F.3). Compute requirements, and run times are appropriately included in Sections E.1, and F.3 in the Appendix. G. Experiment Statistical Significance Question: Does the paper report error bars suitably and correctly defined or other appropriate information about the statistical significance of the experiments? Answer: [Yes] Justification: We report standard deviations for quantitative results over three different seeds. H. Experiments Compute Resources Question: For each experiment, does the paper provide sufficient information on the com- puter resources (type of compute workers, memory, time of execution) needed to reproduce the experiments? Answer: [Yes] Justification: Compute requirements, and run times are appropriately included in Sections E.1, and F.3 in the Appendix. I. Code Of Ethics Question: Does the research conducted in the paper conform, in every respect, with the NeurIPS Code of Ethics https://neurips.cc/public/EthicsGuidelines? Answer: [Yes] Justification: Broader impact and ethics statement is included in Sec. B in the Appendix. J. Broader Impacts Question: Does the paper discuss both potential positive societal impacts and negative societal impacts of the work performed? Answer: [Yes] Justification: Broader impact and ethics statement is included in Sec. B in the Appendix. K. Safeguards Question: Does the paper describe safeguards that have been put in place for responsible release of data or models that have a high risk for misuse (e.g., pretrained language models, image generators, or scraped datasets)? Answer: [NA] Justification: The paper, in fact, presents an approach to make LLM generations safer. While we recognize that any alignment strategy, including the one we propose, can potentially be reversed to engineer an LLM to produce content with elevated levels of toxicity or negative sentiment, we believe addressing the regulation of LLM outputs in response to malicious prompts is a critical area of inquiry. Our hope is that our contributions will positively impact the collective effort towards enhancing the quality of online interactions for the broader community. 35L. Licenses for existing assets Question: Are the creators or original owners of assets (e.g., code, data, models), used in the paper, properly credited and are the license and terms of use explicitly mentioned and properly respected? Answer: [Yes] Justification: We provide necessary citations for code in Sec. E in the Appendix, for datasets in Sections 5 and F.4, and for models in Sections E and F.3 in the Appendix. Our code is based on the open source Tranformers Reinforcement Learning (TRL) repository by Huggingface with Apache-2.0 license. All the datasets used in the work are also available on the Huggingface datasets page under the Apache-2.0 license. M. New Assets Question: Are new assets introduced in the paper well documented and is the documentation provided alongside the assets? Answer: [Yes] Justification: We will open source our code under Apache 2.0 license. N. Crowdsourcing and Research with Human Subjects Question: For crowdsourcing experiments and research with human subjects, does the paper include the full text of instructions given to participants and screenshots, if applicable, as well as details about compensation (if any)? Answer: [NA] O. Institutional Review Board (IRB) Approvals or Equivalent for Research with Human Subjects Question: Does the paper describe potential risks incurred by study participants, whether such risks were disclosed to the subjects, and whether Institutional Review Board (IRB) approvals (or an equivalent approval/review based on the requirements of your country or institution) were obtained? Answer: [NA] 36
```

## **Instructions:**
1. Analyze the paper based on the categories listed below.
2. Your response **must be a valid JSON object** that can be directly parsed using `json.loads()`.
3. Do not include any extra text, explanations, or formatting outside of the JSON object.
4. **If a field has no available information, set its value to `"Not mentioned"` instead of leaving it empty.**
5. Ensure that the JSON format is correct, including the use of **double quotes (`"`) for all keys and values.**
## **Output Format (JSON)**:
```json
{
    "main_contributions": "<Concise description of the main research problem and contributions>",
    "methodology": "<Brief explanation of the key techniques, models, or algorithms>",
    "experimental_setup": "<Description of datasets, benchmarks, and validation methods>",
    "limitations": "<Summary of weaknesses, constraints, or assumptions>",
    "future_research_directions": "<Potential areas for extending this research>"
}
```
Output:
{
    "main_contributions": "This paper addresses the challenge of mitigating negative or toxic content generation by Large Language Models (LLMs) in response to certain prompts, particularly rare but significant events. The main contribution is the integration of risk-averse principles into LLM fine-tuning, specifically optimizing the Conditional Value at Risk (CVaR) measure. The proposed Risk-Averse Reinforcement Learning with Human Feedback (RA-RLHF) methodology trains LLMs to exhibit superior performance in avoiding toxic outputs while maintaining effectiveness in generative tasks, outperforming traditional RLHF, especially for challenging prompts.",
    "methodology": "The methodology adapts the Risk-Averse Reinforcement Learning (RARL) approach to the standard Reinforcement Learning with Human Feedback (RLHF) pipeline, optimizing the Conditional Value at Risk (CVaR) of the return instead of the expected value. It employs a soft-risk scheduling mechanism, inspired by the CeSoR algorithm, to gradually introduce risk-aversion. This involves an initial training phase where the full batch of episodes is used, followed by a gradual reduction of the batch size to focus on trajectories with the lowest returns (worst-case scenarios). The approach starts with a supervised fine-tuned (SFT) base policy for positive episode recognition and regularizes against it using a KL-Divergence term in the reward function. Proximal Policy Optimization (PPO) is used for policy updates, operating in an Actor-Critic setting with a base transformer extended by a language modeling head (actor) and a value function head (critic).",
    "experimental_setup": "The research used GPT2 (117M parameters) and GPT-J (6B parameters) as base LLMs. Experiments were conducted on generative versions of three established classification tasks: IMDB-Gen (sentiment modification), Jigsaw-Gen (toxicity mitigation), and RealToxicityPrompts-Gen (toxicity mitigation). Datasets included IMDB (25k train/test reviews), Jigsaw (36,973 train/7,708 test samples), and RealToxicityPrompts (57,983 train/8,698 test samples). Reward models included `lvwerra/distilbert-imdb` for sentiment and `unitary/toxic-bert` for toxicity. Baselines for comparison were Base LLM, Prompted base LLM, DExperts, SFT, RLHF, and Quark. Evaluation metrics included task performance scores (sentiment/toxicity scores), Perplexity (linguistic coherence), and Distinct-n (textual diversity). Tail sentiment/toxicity scores were specifically evaluated on worst-case prompts. GPT-J experiments utilized Low-Rank Adaptation (LoRA) and bfloat16 precision due to memory constraints.",
    "limitations": "The effectiveness of the risk-averse fine-tuning strategy may vary across different domains and languages, requiring further investigation and adaptation. The work primarily focused on generative tasks and did not explore Question-Answer (Q&A) formats, although the foundational work aims to enable more complex applications like conversational AI. While RA-RLHF showed superior performance, a marginal increase in model perplexity was observed, likely attributed to more aggressive adjustments to satisfy sentiment modification and toxicity mitigation goals. Additionally, ethical considerations regarding potential biases and unintended consequences of LLMs remain paramount and warrant continued attention, acknowledging that any alignment strategy could potentially be reversed to engineer LLM outputs for elevated toxicity.",
    "future_research_directions": "Future research directions include further investigation and adaptation of the risk-averse fine-tuning strategy across different domains and languages. Extending the methodology to more complex applications, such as conversational AI and Question-Answer formats, is also a key area. Continued attention to ethical considerations regarding potential biases and unintended consequences of LLMs is emphasized. The work also establishes groundwork for exploring additional risk measures and criteria, such as the Entropic Value at Risk (EVaR), in the context of LLM safety and uncertainty quantification."
}
